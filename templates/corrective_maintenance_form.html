{% extends "base.html" %}
{% block title %}{% if is_edit and maintenance %}Modifier{% else %}Nouvelle{% endif %} maintenances corrective - {{ machine.name }}{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .form-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .form-label {
    color: #1a3b50;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .form-control, .form-select {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    transition: all 0.2s;
  }
  .form-control:focus, .form-select:focus {
    border-color: #1a3b50;
    box-shadow: 0 0 0 0.25rem rgba(26, 59, 80, 0.25);
    outline: none;
  }
  .btn-success {
    background-color: #1a3b50;
    border-color: #1a3b50;
    color: white;
    font-weight: 600;
    padding: 0.5rem 1.5rem;
    border-radius: 4px;
  }
  .btn-success:hover {
    background-color: #03192f;
    border-color: #03192f;
    color: white;
  }
  .btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
    font-weight: 500;
  }
  .btn-secondary:hover {
    background-color: #5a6268;
    border-color: #5a6268;
    color: white;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .form-card {
      padding: 1.25rem;
    }
    
    .btn-success, .btn-secondary {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .row.g-3 > [class*="col-"] {
      margin-bottom: 1rem;
    }
  }
  
  @media (max-width: 576px) {
    .form-card {
      padding: 1rem;
    }
    
    .row.g-3 > [class*="col-"] {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
</style>

<div class="page-header">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item"><a href="{{ url_for('machines') }}">Machines</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('machine_detail', machine_id=machine.id) }}">{{ machine.name }}</a></li>
      {% if is_edit and maintenance %}
      <li class="breadcrumb-item"><a href="{{ url_for('corrective_maintenance_detail', maintenance_id=maintenance.id) }}">Maintenances corrective</a></li>
      <li class="breadcrumb-item active" aria-current="page">Modifier</li>
      {% else %}
      <li class="breadcrumb-item active" aria-current="page">Maintenances corrective</li>
      {% endif %}
    </ol>
  </nav>
  <h1 class="page-title">{% if is_edit and maintenance %}Modifier la maintenance corrective{% else %}Maintenance corrective{% endif %}</h1>
  <p class="text-muted mt-2">Machine : {{ machine.name }} ({{ machine.code }})</p>
</div>

<div class="form-card">
<form method="post" id="correctiveForm" enctype="multipart/form-data">
  <div class="mb-3">
    <label class="form-label">Date et heure</label>
    <input class="form-control" type="datetime-local" name="created_at" id="maintenanceDate" required 
           {% if is_edit and maintenance and maintenance.created_at %}
           value="{{ maintenance.created_at.strftime('%Y-%m-%dT%H:%M') }}"
           {% endif %} />
  </div>

  <div class="mb-3">
    <label class="form-label">Commentaire</label>
    <textarea class="form-control" name="comment" rows="4" placeholder="Décrivez la maintenance corrective effectuée...">{% if is_edit and maintenance and maintenance.comment %}{{ maintenance.comment }}{% endif %}</textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">Nombre d'heures</label>
    <input class="form-control" type="number" step="0.1" min="0" name="hours" 
           value="{% if is_edit and maintenance and maintenance.hours %}{{ maintenance.hours }}{% endif %}" 
           placeholder="Nombre d'heures de la maintenance" />
    <small class="form-text text-muted">Heures au moment de la maintenance</small>
  </div>

  <hr />
  <h4>Sortie de stock <small class="text-muted">(optionnel)</small></h4>
  {% if stocks %}
  <div class="mb-3">
    <label class="form-label">Stock concerné</label>
    <select class="form-select" name="stock_id">
      <option value="">Aucun stock (optionnel)</option>
      {% for stock in stocks %}
      <option value="{{ stock.id }}" {% if (is_edit and maintenance and maintenance.stock_id == stock.id) or (not is_edit and default_stock_id and stock.id == default_stock_id) %}selected{% endif %}>
        {{ stock.name }} ({{ stock.code }})
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Produits utilisés</label>
    <input class="form-control mb-2" type="text" placeholder="Recherche produit" id="productSearch" />
    <div id="productRows">
      {% if is_edit and maintenance and existing_products %}
        {% for product_id, quantity in existing_products %}
        <div class="row g-2 mb-2 product-row">
          <div class="col-md-6">
            <select class="form-select product-select" name="product_id">
              <option value="">Produit...</option>
              {% for product in products %}
              <option value="{{ product.id }}" data-search="{{ (product.name ~ ' ' ~ product.code)|lower }}"
                      {% if product.id == product_id %}selected{% endif %}>
                {{ product.name }} ({{ product.code }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <input class="form-control" type="number" min="1" step="1" name="quantity" placeholder="Quantité" 
                   value="{{ quantity }}" />
          </div>
          <div class="col-md-3">
            <span class="product-quantity-info text-muted small d-block mt-2" style="display: none !important;">
              <span class="product-quantity-value"></span> disponible(s)
            </span>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="row g-2 mb-2 product-row">
        <div class="col-md-6">
          <select class="form-select product-select" name="product_id">
            <option value="">Produit...</option>
            {% for product in products %}
            <option value="{{ product.id }}" data-search="{{ (product.name ~ ' ' ~ product.code)|lower }}">
              {{ product.name }} ({{ product.code }})
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <input class="form-control" type="number" min="1" step="1" name="quantity" placeholder="Quantité" />
        </div>
        <div class="col-md-3">
          <span class="product-quantity-info text-muted small d-block mt-2" style="display: none !important;">
            <span class="product-quantity-value"></span> disponible(s)
          </span>
        </div>
      </div>
      {% endif %}
    </div>
    <button class="btn btn-outline-secondary btn-sm mt-2" type="button" id="addProduct">+ Produit</button>
  </div>
  {% else %}
  <div class="alert alert-info">
    Aucun stock disponible. La sortie de stock est optionnelle.
  </div>
  {% endif %}

  <hr />
  <h4>Photos <small class="text-muted">(optionnel)</small></h4>
  <div class="mb-3">
    <label class="form-label">Ajouter des photos</label>
    <input class="form-control" type="file" name="photos" multiple accept="image/*" />
    <small class="form-text text-muted">Formats acceptés : JPG, PNG, GIF, WEBP. Vous pouvez sélectionner plusieurs photos.</small>
  </div>

  <div class="mt-4">
    <button class="btn btn-success">{% if is_edit and maintenance %}Modifier la maintenance{% else %}Enregistrer la maintenance{% endif %}</button>
  </div>
</form>
</div>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dateInput = document.getElementById("maintenanceDate");
    if (dateInput && !dateInput.value) {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const day = String(now.getDate()).padStart(2, "0");
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      dateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    const productRows = document.getElementById("productRows");
    const addProductBtn = document.getElementById("addProduct");
    const productSearch = document.getElementById("productSearch");

    function filterProductOptions(query) {
      if (!productRows) return;
      const selects = productRows.querySelectorAll("select");
      selects.forEach((select) => {
        select.querySelectorAll("option").forEach((option) => {
          if (!option.value) return;
          const searchable = option.dataset.search || option.textContent.toLowerCase();
          option.hidden = query && !searchable.includes(query);
        });
      });
    }

    if (addProductBtn && productRows) {
      addProductBtn.addEventListener("click", () => {
        const template = productRows.querySelector(".product-row");
        if (!template) return;
        const clone = template.cloneNode(true);
        clone.querySelectorAll("select, input").forEach((el) => (el.value = ""));
        productRows.appendChild(clone);
        const query = productSearch ? productSearch.value.trim().toLowerCase() : "";
        filterProductOptions(query);
        
        // Appliquer le filtre de stock au nouveau select
        const stockSelect = document.querySelector('select[name="stock_id"]');
        if (stockSelect && stockSelect.value) {
          updateProductsForStock(stockSelect.value);
        }
      });
    }

    if (productSearch) {
      productSearch.addEventListener("input", () => {
        const query = productSearch.value.trim().toLowerCase();
        filterProductOptions(query);
      });
    }

    // Fonction pour mettre à jour la quantité disponible
    function updateProductQuantity(productSelect, quantityInfo) {
      const stockId = document.querySelector('select[name="stock_id"]').value;
      const productId = productSelect.value;
      
      if (!stockId || !productId) {
        quantityInfo.style.display = 'none';
        return;
      }
      
      fetch(`/api/stock/${stockId}/product/${productId}/quantity`)
        .then(response => response.json())
        .then(data => {
          const quantitySpan = quantityInfo.querySelector('.product-quantity-value');
          quantitySpan.textContent = data.quantity;
          quantityInfo.style.display = 'block';
          if (data.quantity === 0) {
            quantityInfo.classList.add('text-danger');
            quantityInfo.classList.remove('text-muted');
          } else {
            quantityInfo.classList.remove('text-danger');
            quantityInfo.classList.add('text-muted');
          }
        })
        .catch(error => {
          console.error('Erreur lors de la récupération de la quantité:', error);
          quantityInfo.style.display = 'none';
        });
    }

    // Fonction pour charger et mettre à jour les produits selon le stock sélectionné
    function updateProductsForStock(stockId) {
      if (!stockId) {
        // Si aucun stock n'est sélectionné, afficher tous les produits
        productRows.querySelectorAll('.product-select').forEach(select => {
          select.querySelectorAll('option').forEach(option => {
            option.hidden = false;
          });
        });
        return;
      }
      
      // Charger les produits du stock sélectionné
      fetch(`/api/stock/${stockId}/products`)
        .then(response => response.json())
        .then(data => {
          const products = data.products;
          const productIds = new Set(products.map(p => p.id));
          
          // Mettre à jour toutes les listes déroulantes de produits
          productRows.querySelectorAll('.product-select').forEach(select => {
            const currentValue = select.value;
            select.querySelectorAll('option').forEach(option => {
              if (!option.value) {
                // Garder l'option vide visible
                option.hidden = false;
              } else {
                // Afficher uniquement les produits disponibles dans ce stock
                option.hidden = !productIds.has(parseInt(option.value));
              }
            });
            
            // Si le produit actuellement sélectionné n'est plus disponible, le désélectionner
            if (currentValue && !productIds.has(parseInt(currentValue))) {
              select.value = '';
              const row = select.closest('.product-row');
              const quantityInfo = row.querySelector('.product-quantity-info');
              if (quantityInfo) {
                quantityInfo.style.display = 'none';
              }
            } else if (currentValue) {
              // Mettre à jour la quantité si un produit est sélectionné
              const row = select.closest('.product-row');
              const quantityInfo = row.querySelector('.product-quantity-info');
              if (quantityInfo) {
                updateProductQuantity(select, quantityInfo);
              }
            }
          });
        })
        .catch(error => {
          console.error('Erreur lors du chargement des produits:', error);
        });
    }

    // Écouter les changements de stock
    const stockSelect = document.querySelector('select[name="stock_id"]');
    if (stockSelect) {
      // Charger les produits au chargement de la page si un stock est déjà sélectionné
      if (stockSelect.value) {
        updateProductsForStock(stockSelect.value);
      }
      
      stockSelect.addEventListener('change', () => {
        updateProductsForStock(stockSelect.value);
      });
    }

    // Écouter les changements de produit dans chaque ligne
    if (productRows) {
      productRows.addEventListener('change', (e) => {
        if (e.target.classList.contains('product-select')) {
          const row = e.target.closest('.product-row');
          const quantityInfo = row.querySelector('.product-quantity-info');
          if (quantityInfo) {
            updateProductQuantity(e.target, quantityInfo);
          }
        }
      });
      
      // Initialiser les quantités pour les produits déjà sélectionnés
      productRows.querySelectorAll('.product-row').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const quantityInfo = row.querySelector('.product-quantity-info');
        if (productSelect && productSelect.value && quantityInfo) {
          updateProductQuantity(productSelect, quantityInfo);
        }
      });
    }
  });
</script>
{% endblock %}

