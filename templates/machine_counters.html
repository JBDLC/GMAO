{% extends "base.html" %}
{% block title %}{{ t('Compteurs') }} - {{ machine.name }}{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .card {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: none;
  }
  .table {
    margin-bottom: 0;
  }
  .table thead th {
    color: #1a3b50;
    font-weight: 600;
    border-bottom: 2px solid #1a3b50;
    background: #f8f9fa;
  }
  .btn-primary {
    background-color: #1a3b50;
    border-color: #1a3b50;
    color: white;
    font-weight: 600;
  }
  .btn-primary:hover {
    background-color: #03192f;
    border-color: #03192f;
    color: white;
  }
  .btn-outline-primary {
    border-color: #1a3b50;
    color: #1a3b50;
  }
  .btn-outline-primary:hover {
    background-color: #1a3b50;
    color: white;
  }
  .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
  }
  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
  }
  
  /* Styles pour l'indentation hiérarchique */
  .hierarchy-indent {
    display: inline-block;
    width: 20px;
  }
  .hierarchy-line {
    color: #6c757d;
    margin-right: 8px;
    font-size: 1.1em;
    font-weight: 300;
  }
  .machine-row-level-0 {
    background: linear-gradient(90deg, rgba(26, 59, 80, 0.08) 0%, rgba(26, 59, 80, 0.03) 100%) !important;
    border-left: 3px solid #1a3b50;
    font-weight: 600;
  }
  .machine-row-level-1 {
    background: linear-gradient(90deg, rgba(26, 59, 80, 0.05) 0%, rgba(26, 59, 80, 0.02) 100%) !important;
    border-left: 3px solid rgba(26, 59, 80, 0.4);
  }
  .machine-row-level-2 {
    background: linear-gradient(90deg, rgba(108, 117, 125, 0.04) 0%, rgba(108, 117, 125, 0.01) 100%) !important;
    border-left: 2px solid rgba(108, 117, 125, 0.3);
  }
  .machine-row-level-3 {
    background-color: #ffffff !important;
    border-left: 2px solid rgba(173, 181, 189, 0.2);
  }
  .counter-row {
    background-color: #f8f9fa !important;
    font-size: 0.95em;
    border-left: 2px solid rgba(26, 59, 80, 0.15);
    transition: background-color 0.2s;
  }
  .counter-row:hover {
    background-color: #e9ecef !important;
  }
  .counter-row td {
    border-top: 1px solid rgba(0, 0, 0, 0.05);
  }
  .level-separator {
    height: 2px;
    background: linear-gradient(to right, transparent, rgba(26, 59, 80, 0.2), transparent);
    border: none;
    margin: 8px 0;
  }
  .machine-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    background-color: rgba(26, 59, 80, 0.15);
    color: #1a3b50;
    font-size: 0.75em;
    font-weight: 600;
    margin-left: 8px;
    border: 1px solid rgba(26, 59, 80, 0.2);
  }
  .counter-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 10px;
    background-color: rgba(108, 117, 125, 0.12);
    color: #495057;
    font-size: 0.7em;
    font-weight: 500;
    margin-left: 6px;
    border: 1px solid rgba(108, 117, 125, 0.2);
  }
  .machine-group {
    border-bottom: 2px solid rgba(26, 59, 80, 0.1);
    margin-bottom: 4px;
  }
  .machine-name-header {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .counter-type-indicator {
    font-size: 0.7em;
    color: #6c757d;
    font-weight: 400;
    font-style: italic;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }
    
    .btn-primary {
      width: 100%;
    }
    
    .table-responsive {
      font-size: 0.875rem;
    }
    
    .table th, .table td {
      padding: 0.5rem 0.25rem;
    }
  }
  
  @media (max-width: 576px) {
    .table th, .table td {
      padding: 0.375rem 0.125rem;
      font-size: 0.8rem;
    }
  }
</style>

<div class="page-header">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item"><a href="{{ url_for('machines') }}">{{ t('Machines') }}</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('machine_detail', machine_id=machine.id) }}">{{ machine.name }}</a></li>
      <li class="breadcrumb-item active">{{ t('Compteurs') }}</li>
    </ol>
  </nav>
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="page-title">{{ t('Compteurs de') }} {{ machine.name }}</h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{{ url_for('machines') }}">{{ t('Machines') }}</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('machine_detail', machine_id=machine.id) }}">{{ machine.name }}</a></li>
        <li class="breadcrumb-item active">{{ t('Compteurs') }}</li>
      </ol>
    </nav>
    <a href="{{ url_for('new_counter', machine_id=machine.id) }}" class="btn btn-primary">+ {{ t('Nouveau compteur') }}</a>
  </div>
</div>

{% if counter_hierarchy %}
<div class="card mt-3">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>{{ t('Machine / Compteur') }}</th>
            <th>{{ t('Code') }}</th>
            <th>{{ t('Valeur') }}</th>
            <th>{{ t('Unité') }}</th>
            <th>{{ t('Actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% set current_depth = -1 %}
          {% set current_machine_id = None %}
          {% for item in counter_hierarchy %}
            {% set depth = item.depth %}
            {% set machine_item = item.machine %}
            
            {# Ajouter un séparateur visuel si on change de machine racine ou si on remonte dans la hiérarchie #}
            {% if current_machine_id is not none and (machine_item.id != current_machine_id or depth < current_depth) %}
              <tr>
                <td colspan="5" class="level-separator"></td>
              </tr>
            {% endif %}
            
            {% if item.type == 'machine_with_counters' %}
              {# Machine avec compteurs multiples (racine ou sous-machine) #}
              {% set padding_left = depth * 30 %}
              {% set is_root = depth == 0 %}
              <tr class="machine-row-level-{{ depth if depth <= 3 else 3 }}">
                <td style="padding: 16px; padding-left: {{ padding_left }}px;">
                  <div class="machine-name-header">
                    {% if depth > 0 %}
                      <span class="hierarchy-line">└─</span>
                    {% endif %}
                    <span style="color: #1a3b50; font-size: {% if is_root %}1.2em{% else %}1.05em{% endif %}; font-weight: 600;">
                      {{ machine_item.name }}
                    </span>
                    <span class="machine-badge">
                      {{ item.counters|length }} {% if item.counters|length > 1 %}{{ t('compteurs') }}{% else %}{{ t('compteur') }}{% endif %}
                    </span>
                    {% if not is_root %}
                      <span class="counter-type-indicator">({{ t('Sous-machine') }})</span>
                    {% endif %}
                  </div>
                </td>
                <td style="padding: 16px; {% if is_root %}font-weight: 600; color: #1a3b50;{% else %}color: #6c757d;{% endif %}">
                  {{ machine_item.code }}
                </td>
                <td colspan="3" style="padding: 16px; color: #6c757d; font-size: 0.9em; font-style: italic;">
                  {{ t('Voir les compteurs ci-dessous') }}
                </td>
              </tr>
              {# Afficher tous les compteurs de cette machine directement en dessous #}
              {% for counter in item.counters %}
                {% set unit = counter.unit or 'h' %}
                <tr class="counter-row">
                  <td style="padding: 12px; padding-left: {{ padding_left + 40 }}px;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                      <span class="hierarchy-line">└─</span> 
                      <span style="color: #1a3b50; font-weight: 500;">{{ counter.name }}</span>
                      <span class="counter-badge">{{ machine_item.code }}</span>
                    </div>
                  </td>
                  <td style="padding: 12px; color: #6c757d; font-size: 0.9em;">{{ machine_item.code }}</td>
                  <td style="padding: 12px; font-weight: 500; color: #495057;">
                    {{ "%.1f"|format(counter.value) }}
                  </td>
                  <td style="padding: 12px; color: #6c757d; font-size: 0.9em;">{{ unit }}</td>
                  <td style="padding: 12px;">
                    <div class="btn-group">
                      <a href="{{ url_for('edit_counter', machine_id=machine_item.id, counter_id=counter.id) }}" class="btn btn-sm btn-outline-primary" title="{{ t('Modifier') }}">
                        {{ icon_svg('edit', 16) }}
                      </a>
                      <form method="post" action="{{ url_for('delete_counter', machine_id=machine_item.id, counter_id=counter.id) }}" class="d-inline" onsubmit="return confirm('{{ t('Êtes-vous sûr de vouloir supprimer ce compteur ?') }}');">
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ t('Supprimer') }}">
                          {{ icon_svg('delete', 16) }}
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% elif item.type == 'machine_single_counter' %}
              {# Machine avec compteur classique unique #}
              {% set unit = machine_item.counter_unit or 'h' %}
              {% set padding_left = depth * 30 %}
              {% set is_root = depth == 0 %}
              <tr class="machine-row-level-{{ depth if depth <= 3 else 3 }}">
                <td style="padding: 16px; padding-left: {{ padding_left }}px;">
                  <div class="machine-name-header">
                    {% if depth > 0 %}
                      <span class="hierarchy-line">└─</span>
                    {% endif %}
                    <span style="color: #1a3b50; font-size: {% if is_root %}1.2em{% else %}1.05em{% endif %}; font-weight: 600;">
                      {{ machine_item.name }}
                    </span>
                    <span class="counter-badge">{{ "%.1f"|format(machine_item.hours) }} {{ unit }}</span>
                    {% if not is_root %}
                      <span class="counter-type-indicator">({{ t('Sous-machine') }})</span>
                    {% endif %}
                  </div>
                </td>
                <td style="padding: 16px; {% if is_root %}font-weight: 600; color: #1a3b50;{% else %}color: #6c757d;{% endif %}">
                  {{ machine_item.code }}
                </td>
                <td style="padding: 16px; font-weight: 500; color: #495057;">
                  {{ "%.1f"|format(machine_item.hours) }}
                </td>
                <td style="padding: 16px; color: #6c757d; font-size: 0.9em;">{{ unit }}</td>
                <td style="padding: 16px;">
                  <span class="badge bg-info">{{ t('Compteur machine') }}</span>
                </td>
              </tr>
            {% endif %}
            
            {% set current_depth = depth %}
            {% set current_machine_id = machine_item.id %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-info">
  <p class="mb-0">{{ t('Aucun compteur configuré pour cette machine racine.') }}</p>
  <p class="mb-0 mt-2"><a href="{{ url_for('new_counter', machine_id=machine.id) }}" class="btn btn-primary btn-sm">{{ t('Créer le premier compteur') }}</a></p>
</div>
{% endif %}

<div class="mt-3">
  <a href="{{ url_for('machine_detail', machine_id=machine.id) }}" class="btn btn-secondary">{{ t('Retour à la machine') }}</a>
</div>
{% endblock %}

