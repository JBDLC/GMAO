{% extends "base.html" %}
{% block title %}Produits{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  .table thead th {
    color: #1a3b50;
    font-weight: 600;
    border-bottom: 2px solid #1a3b50;
    background: #f8f9fa;
  }
  .btn-success {
    background-color: #1a3b50;
    border-color: #1a3b50;
    color: white;
    font-weight: 600;
  }
  .btn-success:hover {
    background-color: #03192f;
    border-color: #03192f;
    color: white;
  }
  .btn-primary {
    background-color: #1a3b50;
    border-color: #1a3b50;
    color: white;
    font-weight: 600;
  }
  .btn-primary:hover {
    background-color: #03192f;
    border-color: #03192f;
    color: white;
  }
  .btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
  }
  .btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
  }
  .form-select-sm {
    border-color: #ced4da;
  }
  .form-select-sm:focus {
    border-color: #1a3b50;
    box-shadow: 0 0 0 0.25rem rgba(26, 59, 80, 0.25);
  }
  
  .products-actions-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: nowrap;
    flex: 1 1 auto;
    min-width: 0;
  }
  
  .products-filter-select {
    min-width: 150px;
    max-width: 180px;
    border-radius: 8px;
    flex: 0 0 auto;
  }
  
  .page-header .d-flex.justify-content-between {
    flex-wrap: nowrap;
    gap: 1rem;
    align-items: center;
    width: 100%;
  }
  
  .page-header .page-title {
    flex: 0 0 auto;
    white-space: nowrap;
  }
  
  .page-header .products-actions-container {
    flex: 1 1 auto;
    min-width: 0;
    justify-content: flex-end;
  }
  
  .btn-icon-only {
    width: 40px;
    height: 40px;
    min-width: 40px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
    flex: 0 0 auto;
  }
  
  .btn-icon-only:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .btn-icon-only img {
    margin: 0;
    width: 18px;
    height: 18px;
  }
  
  .btn-add-product {
    width: 40px;
    height: 40px;
    min-width: 40px;
    padding: 0;
    border-radius: 50%;
    font-size: 22px;
    font-weight: 600;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex: 0 0 auto;
  }
  
  .btn-add-product:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(26, 59, 80, 0.2);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }
    
    .products-actions-container {
      width: 100%;
      gap: 0.5rem;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 4px;
      justify-content: flex-start;
    }
    
    .products-filter-select {
      min-width: 140px;
      flex-shrink: 0;
    }
    
    .btn-icon-only,
    .btn-add-product {
      width: 40px;
      height: 40px;
      min-width: 40px;
      flex: 0 0 40px;
    }
    
    .form-select-sm {
      width: 100% !important;
    }
    
    .table-responsive {
      font-size: 0.875rem;
    }
    
    .table th, .table td {
      padding: 0.5rem 0.25rem;
    }
    
    .modal-dialog {
      margin: 0.5rem;
    }
    
    .modal-content {
      padding: 1rem;
    }
  }
  
  @media (max-width: 576px) {
    .table th, .table td {
      padding: 0.375rem 0.125rem;
      font-size: 0.75rem;
    }
    
    /* Masquer certaines colonnes sur très petits écrans */
    .table th:nth-child(4),
    .table td:nth-child(4),
    .table th:nth-child(5),
    .table td:nth-child(5),
    .table th:nth-child(6),
    .table td:nth-child(6) {
      display: none;
    }
  }
</style>

<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="page-title">{{ t('Produits') }}</h1>
  <div class="products-actions-container">
    <select class="form-select form-select-sm products-filter-select" id="filter_stock" onchange="applyFilters()">
      <option value="">{{ t('Tous les stocks') }}</option>
      {% for stock in stocks %}
      <option value="{{ stock.id }}" {% if filter_stock_id == stock.id %}selected{% endif %}>
        {{ stock.name }}{% if main_stock_id and stock.id == main_stock_id %}*{% endif %}
      </option>
      {% endfor %}
    </select>
    <button type="button" class="btn btn-outline-warning btn-icon-only {% if filter_low_stock %}active{% endif %}" onclick="toggleLowStockFilter()" title="{{ t('Stock faible') }}">
      {{ icon_svg('alert-triangle', 18) }}
    </button>
    <a href="{{ url_for('products') }}" class="btn btn-outline-secondary btn-icon-only" title="{{ t('Réinitialiser les filtres') }}">
      {{ icon_svg('reset', 18) }}
    </a>
    <a href="{{ url_for('export_products', filter_name=filter_name, filter_code=filter_code, filter_supplier=filter_supplier, filter_min_stock=filter_min_stock, filter_low_stock=('1' if filter_low_stock else ''), filter_stock_id=(filter_stock_id if filter_stock_id else '')) }}" class="btn btn-success btn-icon-only" title="{{ t('Exporter en Excel') }}">
      {{ icon_svg('export', 18) }}
    </a>
    {% if can_edit_stocks_products() and not is_readonly_stocks_products() %}
    <button type="button" class="btn btn-info btn-icon-only" data-bs-toggle="modal" data-bs-target="#importModal" title="{{ t('Importer des produits depuis Excel') }}">
      {{ icon_svg('import', 18) }}
    </button>
    <button type="button" class="btn btn-primary btn-add-product" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openProductModal(); return false;" title="{{ t('Nouveau produit') }}">
      +
    </button>
    {% endif %}
  </div>
</div>

{% if products %}
<div class="table-responsive mt-3">
  <table class="table table-hover" style="font-size: 0.875rem;">
    <thead class="table-light">
      <tr>
        <th>{{ t('Nom') }}</th>
        <th>{{ t('Code') }}</th>
        <th>{{ t('Code emplacement') }}</th>
        <th>{{ t('Prix') }}</th>
        <th>{{ t('Fournisseur') }}</th>
        <th>{{ t('Stock min.') }}</th>
        {% if filter_stock_id %}
          {% for stock in stocks %}
            {% if stock.id == filter_stock_id %}
            <th class="text-center">
              {{ stock.name }}{% if main_stock_id and stock.id == main_stock_id %}*{% endif %}
            </th>
            {% endif %}
          {% endfor %}
        {% else %}
          {% for stock in stocks %}
          <th class="text-center">
            {{ stock.name }}{% if main_stock_id and stock.id == main_stock_id %}*{% endif %}
          </th>
          {% endfor %}
        {% endif %}
        <th class="text-center fw-bold">{{ t('Total stocks') }}</th>
        <th class="text-center">{{ t('Actions') }}</th>
      </tr>
      <tr>
        <th>
          <input type="text" class="form-control form-control-sm" id="filter_name" 
                 placeholder="{{ t('Rechercher...') }}" value="{{ filter_name }}" onkeyup="applyFilters()">
        </th>
        <th>
          <input type="text" class="form-control form-control-sm" id="filter_code" 
                 placeholder="Rechercher..." value="{{ filter_code }}" onkeyup="applyFilters()">
        </th>
        <th></th>
        <th></th>
        <th>
          <input type="text" class="form-control form-control-sm" id="filter_supplier" 
                 placeholder="Rechercher..." value="{{ filter_supplier }}" onkeyup="applyFilters()">
        </th>
        <th>
          <input type="number" class="form-control form-control-sm" id="filter_min_stock" 
                 placeholder="{{ t('Min...') }}" value="{{ filter_min_stock }}" step="0.01" onchange="applyFilters()">
        </th>
        {% if filter_stock_id %}
          {% for stock in stocks %}
            {% if stock.id == filter_stock_id %}
            <th></th>
            {% endif %}
          {% endfor %}
        {% else %}
          {% for stock in stocks %}
          <th></th>
          {% endfor %}
        {% endif %}
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for product in products %}
      <tr>
        <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">{{ product.name }}</td>
        <td style="white-space: nowrap;">{{ product.code }}</td>
        <td style="white-space: nowrap;">{{ product.location_code or "-" }}</td>
        <td style="white-space: nowrap;">{{ "%.2f"|format(product.price) }} €</td>
        <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;">
          {{ product.supplier_name or "-" }}
          {% if product.supplier_reference %}
          <br><small class="text-muted">REF: {{ product.supplier_reference }}</small>
          {% endif %}
        </td>
        <td style="white-space: nowrap;">{{ product.minimum_stock|int }}</td>
        {% if filter_stock_id %}
          {% for stock in stocks %}
            {% if stock.id == filter_stock_id %}
            <td class="text-center">
              {% set qty = quantities_by_product[product.id][stock.id] %}
              <span class="{% if product.minimum_stock > 0 and qty < product.minimum_stock %}text-danger fw-bold{% endif %}">
                {{ qty|int }}
              </span>
            </td>
            {% endif %}
          {% endfor %}
        {% else %}
          {% for stock in stocks %}
          <td class="text-center">
            {% set qty = quantities_by_product[product.id][stock.id] %}
            <span class="{% if product.minimum_stock > 0 and qty < product.minimum_stock %}text-danger fw-bold{% endif %}">
              {{ qty|int }}
            </span>
          </td>
          {% endfor %}
        {% endif %}
        <td class="text-center fw-bold">
          {% set total = total_by_product[product.id] %}
          <span class="{% if product.minimum_stock > 0 and total < product.minimum_stock %}text-danger{% else %}text-primary{% endif %}">
            {{ total|int }}
          </span>
        </td>
        {% if can_edit_stocks_products() and not is_readonly_stocks_products() %}
        <td class="text-center" style="white-space: nowrap;">
          <button type="button" class="btn btn-outline-primary" style="padding: 0.125rem 0.25rem; font-size: 0.75rem; line-height: 1.2;" onclick="editProduct({{ product.id }})" title="Modifier">
            <img src="{{ url_for('static', filename='icons/edit.svg') }}" alt="Modifier" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;">
          </button>
          {% if can_delete_products() %}
          <form method="post" action="{{ url_for('delete_product', product_id=product.id) }}" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce produit ?');">
            <button type="submit" class="btn btn-outline-danger" style="padding: 0.125rem 0.25rem; font-size: 0.75rem; line-height: 1.2;" title="Supprimer"><img src="{{ url_for('static', filename='icons/delete.svg') }}" alt="Supprimer" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></button>
          </form>
          {% endif %}
        </td>
        {% else %}
        <td></td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">
  <p class="mb-0">Aucun produit{% if filter_name or filter_code or filter_supplier or filter_min_stock or filter_low_stock or filter_stock_id %} correspondant aux filtres{% endif %}. {% if not filter_name and not filter_code and not filter_supplier and not filter_min_stock and not filter_low_stock and not filter_stock_id %}Cliquez sur "Nouveau produit" pour en créer un.{% endif %}</p>
</div>
{% endif %}

<!-- Modal pour créer/modifier un produit -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Nouveau produit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="productForm" action="{{ url_for('products') }}">
        <div class="modal-body">
          <input type="hidden" id="productId" name="product_id">
          <div class="mb-3">
            <label class="form-label">Nom <span class="text-danger">*</span></label>
            <input class="form-control" id="productName" name="name" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Code <span class="text-danger">*</span></label>
            <input class="form-control" id="productCode" name="code" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Code emplacement</label>
            <input class="form-control" id="productLocationCode" name="location_code" />
          </div>
          <div class="mb-3">
            <label class="form-label">Prix</label>
            <input class="form-control" id="productPrice" name="price" type="number" step="0.01" value="0" />
          </div>
          <div class="mb-3">
            <label class="form-label">Fournisseur</label>
            <input class="form-control" id="productSupplier" name="supplier_name" />
          </div>
          <div class="mb-3">
            <label class="form-label">REF (Référence fournisseur)</label>
            <input class="form-control" id="productSupplierRef" name="supplier_reference" />
          </div>
          <div class="mb-3">
            <label class="form-label">Stock minimum</label>
            <input class="form-control" id="productMinStock" name="minimum_stock" type="number" step="0.01" value="0" />
          </div>
          <div class="mb-3" id="stockSelectionContainer">
            <label class="form-label">Stock <span class="text-muted">(optionnel)</span></label>
            <select class="form-select" id="productStock" name="stock_id">
              <option value="">Aucun stock</option>
              {% for stock in stocks %}
              <option value="{{ stock.id }}">{{ stock.name }} ({{ stock.code }})</option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Sélectionnez un stock pour ajouter ce produit avec une quantité initiale.</small>
          </div>
          <div class="mb-3" id="initialQuantityContainer" style="display: none;">
            <label class="form-label">Quantité initiale</label>
            <input class="form-control" id="productInitialQuantity" name="initial_quantity" type="number" step="0.01" min="0" value="0" />
            <small class="form-text text-muted">Quantité à ajouter au stock sélectionné lors de la création.</small>
          </div>
          <div class="mb-3" id="currentStockContainer" style="display: none;">
            <label class="form-label">Stock actuel</label>
            <select class="form-select" id="productCurrentStock" name="current_stock_id">
              <option value="">Aucun stock</option>
              {% for stock in stocks %}
              <option value="{{ stock.id }}">{{ stock.name }} ({{ stock.code }})</option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Sélectionnez le stock où se trouve actuellement ce produit. Si vous changez, la quantité sera déplacée.</small>
          </div>
          <div class="mb-3" id="currentQuantityContainer" style="display: none;">
            <label class="form-label">Quantité actuelle dans le stock</label>
            <input class="form-control" id="productCurrentQuantity" type="number" step="0.01" readonly />
            <small class="form-text text-muted">Quantité actuelle dans le stock sélectionné.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal pour importer des produits depuis Excel -->
{% if can_edit_stocks_products() and not is_readonly_stocks_products() %}
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importModalLabel">Importer des produits depuis Excel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('import_products') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label for="excelFile" class="form-label">Fichier Excel</label>
            <input type="file" class="form-control" id="excelFile" name="file" accept=".xlsx,.xls" required />
            <div class="form-text">
              Le fichier Excel doit contenir les colonnes suivantes (dans l'ordre) :
              <ul class="mb-0 mt-2">
                <li><strong>Colonne 1 :</strong> Nom du produit (obligatoire)</li>
                <li><strong>Colonne 2 :</strong> Code du produit (obligatoire, doit être unique)</li>
                <li><strong>Colonne 3 :</strong> Prix (optionnel, défaut: 0)</li>
                <li><strong>Colonne 4 :</strong> Fournisseur (optionnel)</li>
                <li><strong>Colonne 5 :</strong> Stock minimum (optionnel, défaut: 0)</li>
              </ul>
              <p class="mt-2 mb-0"><small class="text-muted">Note : Les produits avec un code déjà existant seront ignorés.</small></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Importer</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
let productModal;
let productForm;

document.addEventListener('DOMContentLoaded', function() {
  productModal = new bootstrap.Modal(document.getElementById('productModal'));
  productForm = document.getElementById('productForm');
});

function openProductModal() {
  const modal = document.getElementById('productModal');
  const modalTitle = document.getElementById('productModalLabel');
  const form = document.getElementById('productForm');
  const productIdInput = document.getElementById('productId');
  
  // Réinitialiser le formulaire
  form.reset();
  form.action = "{{ url_for('products') }}";
  form.method = "post";
  
  // Masquer les champs de modification
  document.getElementById('stockSelectionContainer').style.display = 'block';
  document.getElementById('initialQuantityContainer').style.display = 'none';
  document.getElementById('currentStockContainer').style.display = 'none';
  document.getElementById('currentQuantityContainer').style.display = 'none';
  
  modalTitle.textContent = 'Nouveau produit';
  productIdInput.value = '';
  
  // Retirer les anciens listeners pour éviter les doublons
  const stockSelect = document.getElementById('productStock');
  const newStockSelect = stockSelect.cloneNode(true);
  stockSelect.parentNode.replaceChild(newStockSelect, stockSelect);
  
  // Afficher la quantité initiale lors de la création
  newStockSelect.addEventListener('change', function() {
    if (this.value) {
      document.getElementById('initialQuantityContainer').style.display = 'block';
    } else {
      document.getElementById('initialQuantityContainer').style.display = 'none';
    }
  });
  
  productModal.show();
}

async function editProduct(productId) {
  try {
    const response = await fetch(`/api/products/${productId}`);
    const data = await response.json();
    
    if (!data.success) {
      alert('Erreur lors du chargement du produit');
      return;
    }
    
    const product = data.product;
    const modal = document.getElementById('productModal');
    const modalTitle = document.getElementById('productModalLabel');
    const form = document.getElementById('productForm');
    const productIdInput = document.getElementById('productId');
    
    // Réinitialiser le formulaire
    form.reset();
    
    // Remplir les champs
    modalTitle.textContent = 'Modifier le produit';
    document.getElementById('productName').value = product.name;
    document.getElementById('productCode').value = product.code;
    document.getElementById('productLocationCode').value = product.location_code || '';
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productSupplier').value = product.supplier_name || '';
    document.getElementById('productSupplierRef').value = product.supplier_reference || '';
    document.getElementById('productMinStock').value = product.minimum_stock;
    productIdInput.value = productId;
    
    // Changer l'action du formulaire pour la modification
    form.action = "{{ url_for('edit_product', product_id=0) }}".replace('0', productId);
    
    // Gérer les stocks
    // Masquer les champs de création
    document.getElementById('stockSelectionContainer').style.display = 'none';
    document.getElementById('initialQuantityContainer').style.display = 'none';
    
    // Afficher les champs de modification
    document.getElementById('currentStockContainer').style.display = 'block';
    document.getElementById('currentQuantityContainer').style.display = 'block';
    
    // Si le produit est dans un seul stock, le pré-sélectionner
    if (product.stocks && product.stocks.length > 0) {
      const firstStock = product.stocks[0];
      document.getElementById('productCurrentStock').value = firstStock.stock_id;
      document.getElementById('productCurrentQuantity').value = firstStock.quantity;
    } else {
      document.getElementById('productCurrentStock').value = '';
      document.getElementById('productCurrentQuantity').value = '0';
    }
    
    // Retirer les anciens listeners pour éviter les doublons
    const currentStockSelect = document.getElementById('productCurrentStock');
    const newCurrentStockSelect = currentStockSelect.cloneNode(true);
    currentStockSelect.parentNode.replaceChild(newCurrentStockSelect, currentStockSelect);
    
    // Écouter les changements de stock pour mettre à jour la quantité affichée
    newCurrentStockSelect.addEventListener('change', function() {
      const selectedStockId = parseInt(this.value);
      const stock = product.stocks.find(s => s.stock_id === selectedStockId);
      if (stock) {
        document.getElementById('productCurrentQuantity').value = stock.quantity;
      } else {
        document.getElementById('productCurrentQuantity').value = '0';
      }
    });
    
    productModal.show();
  } catch (error) {
    console.error('Erreur:', error);
    alert('Erreur lors du chargement du produit');
  }
}

let filterTimeout;
let lowStockFilterActive = {% if filter_low_stock %}true{% else %}false{% endif %};

function applyFilters() {
  clearTimeout(filterTimeout);
  filterTimeout = setTimeout(() => {
    const params = new URLSearchParams();
    
    const filterName = document.getElementById('filter_name').value;
    const filterCode = document.getElementById('filter_code').value;
    const filterSupplier = document.getElementById('filter_supplier').value;
    const filterMinStock = document.getElementById('filter_min_stock').value;
    const filterStock = document.getElementById('filter_stock').value;
    
    if (filterName) params.set('filter_name', filterName);
    if (filterCode) params.set('filter_code', filterCode);
    if (filterSupplier) params.set('filter_supplier', filterSupplier);
    if (filterMinStock) params.set('filter_min_stock', filterMinStock);
    if (filterStock) {
      params.set('filter_stock_id', filterStock);
    } else {
      // Supprimer le paramètre si on sélectionne "Tous les stocks"
      params.delete('filter_stock_id');
    }
    if (lowStockFilterActive) params.set('filter_low_stock', '1');
    
    const queryString = params.toString();
    window.location.href = '{{ url_for("products") }}' + (queryString ? '?' + queryString : '');
  }, 500);
}

function toggleLowStockFilter() {
  lowStockFilterActive = !lowStockFilterActive;
  applyFilters();
}

// Pour les champs texte, utiliser un délai, pour les autres appliquer immédiatement
document.getElementById('filter_name').addEventListener('keyup', applyFilters);
document.getElementById('filter_code').addEventListener('keyup', applyFilters);
document.getElementById('filter_supplier').addEventListener('keyup', applyFilters);
document.getElementById('filter_min_stock').addEventListener('change', () => {
  clearTimeout(filterTimeout);
  applyFilters();
});
</script>
{% endblock %}
