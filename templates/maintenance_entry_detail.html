{% extends "base.html" %}
{% block title %}{{ entry.report.name }} - {{ entry.machine.name }}{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .info-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .info-card h5 {
    color: #1a3b50;
    font-weight: 600;
    margin-bottom: 1rem;
  }
  .list-group-item {
    border-left: 3px solid #1a3b50;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    padding: 1rem;
    background: #f8f9fa;
  }
  .btn-outline-primary {
    border-color: #1a3b50;
    color: #1a3b50;
  }
  .btn-outline-primary:hover {
    background-color: #1a3b50;
    color: white;
  }
  .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
  }
  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
  }
  .table {
    margin-bottom: 0;
  }
  .table thead th {
    color: #1a3b50;
    font-weight: 600;
    border-bottom: 2px solid #1a3b50;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }
    
    .btn-group {
      flex-direction: column;
      width: 100%;
    }
    
    .btn-group > * {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .info-card {
      padding: 1rem;
    }
    
    .list-group-item {
      padding: 0.75rem;
    }
    
    .table-responsive {
      font-size: 0.875rem;
    }
    
    .table th, .table td {
      padding: 0.5rem 0.25rem;
    }
  }
  
  @media (max-width: 576px) {
    .info-card {
      padding: 0.75rem;
    }
    
    .list-group-item {
      padding: 0.5rem;
    }
    
    .table th, .table td {
      padding: 0.375rem 0.125rem;
      font-size: 0.8rem;
    }
  }
</style>

<div class="page-header">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item"><a href="{{ url_for('machines') }}">Machines</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('machine_detail', machine_id=entry.machine.id) }}">{{ entry.machine.name }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Rapport du {{ entry.created_at.strftime("%d/%m/%Y %H:%M") }}</li>
    </ol>
  </nav>
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="page-title">{{ entry.report.name }}</h1>
      <p class="text-muted mb-0 mt-2">
        {{ entry.machine.name }} ({{ entry.machine.code }}) · {{ entry.created_at.strftime("%d/%m/%Y %H:%M") }}
        {% if entry.user %}
        · Identifiant : {{ entry.user.username }}
        {% endif %}
        {% if entry.stock %}
        · Stock : {{ entry.stock.name }} ({{ entry.stock.code }})
        {% endif %}
      </p>
    </div>
    <div class="btn-group">
    {% if current_user.user_type == 'admin' or (current_user.user_type == 'technicien' and entry.user_id == current_user.id) %}
    <a class="btn btn-outline-primary" href="{{ url_for('edit_maintenance_entry', entry_id=entry.id) }}" title="Modifier le rapport"><img src="{{ url_for('static', filename='icons/edit.svg') }}" alt="Modifier" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></a>
    {% endif %}
      {% if current_user.user_type == 'admin' %}
      <form method="post" action="{{ url_for('delete_maintenance_entry', entry_id=entry.id) }}" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette maintenance ? Cette action est irréversible et remettra les produits en stock.');">
        <button type="submit" class="btn btn-outline-danger" title="Supprimer"><img src="{{ url_for('static', filename='icons/delete.svg') }}" alt="Supprimer" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></button>
      </form>
      {% endif %}
    </div>
  </div>
</div>

{% if entry.machine.hour_counter_enabled or entry.triggered_counter_id or entry.report.report_counters %}
{% set unit = entry.machine.counter_unit or 'h' %}
<div class="info-card">
  <h5>Informations de compteur</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <strong>Valeur du compteur à l'instant de la maintenance :</strong><br>
        <span class="text-muted">{{ "%.1f"|format(entry.performed_hours) }} {{ unit }}</span>
      </div>
      {% if entry.hours_before_maintenance is not none %}
      <div class="col-md-6">
        <strong>Avant maintenance :</strong><br>
        <span class="text-muted">
          {% if entry.hours_before_maintenance < 0 %}
          <span class="text-danger">{{ "%.1f"|format(entry.hours_before_maintenance) }} {{ unit }} (retard)</span>
          {% elif entry.hours_before_maintenance == 0 %}
          <span class="text-danger">0 {{ unit }} (due)</span>
          {% else %}
          {{ "%.1f"|format(entry.hours_before_maintenance) }} {{ unit }}
          {% endif %}
        </span>
      </div>
      {% endif %}
      {% if entry.triggered_counter_id or (entry.triggered_counter_id is none and entry.machine.hour_counter_enabled) %}
      <div class="col-md-12 mt-2">
        <strong>Compteur ayant déclenché la maintenance :</strong><br>
        <span class="text-muted">
          {% if entry.triggered_counter_id and entry.triggered_counter %}
          {{ entry.triggered_counter.name }}
          {% elif entry.triggered_counter_id is none and entry.machine.hour_counter_enabled %}
          Compteur de {{ entry.machine.name }}
          {% elif entry.report.report_counters %}
          {% set root_machine = entry.machine %}
          {% while root_machine.parent %}
            {% set root_machine = root_machine.parent %}
          {% endwhile %}
          Compteur de la machine racine {{ root_machine.name }}
          {% endif %}
        </span>
      </div>
      {% endif %}
    </div>
</div>
{% endif %}

<div class="info-card">
  <h5>Éléments du rapport</h5>
  <div class="list-group">
  {% for value in entry.values %}
  <div class="list-group-item">
    <div class="row g-2 align-items-center">
      <div class="col-md-3 col-lg-2">
        <strong>{{ value.component.label }}</strong>
      </div>
      <div class="col-md-2 col-lg-2">
        <span class="text-muted small">Type : {{ value.component.field_type }}</span>
      </div>
      <div class="col-md-7 col-lg-8">
        {% if value.component.field_type == "number" %}
        <span class="fw-normal">{{ value.value_number }}</span>
        {% elif value.component.field_type == "checkbox" %}
        {% if value.value_bool %}
        <span class="badge bg-success">Validé</span>
        {% else %}
        <span class="badge bg-secondary">Non validé</span>
        {% endif %}
        {% else %}
        <span class="fw-normal">{{ value.value_text }}</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
  </div>
</div>

{% if movement and movement.items %}
<div class="info-card">
  <h5>Produits utilisés</h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Produit</th>
            <th>Code</th>
            <th>Quantité</th>
            <th class="text-end">Prix unitaire</th>
            <th class="text-end">Prix total</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(total_price=0.0) %}
          {% for item in movement.items %}
          {% set line_total = item.product.price * item.quantity %}
          {% set ns.total_price = ns.total_price + line_total %}
          <tr>
            <td>{{ item.product.name }}</td>
            <td>{{ item.product.code }}</td>
            <td>{{ item.quantity }}</td>
            <td class="text-end">{{ "%.2f"|format(item.product.price) }} €</td>
            <td class="text-end fw-bold">{{ "%.2f"|format(line_total) }} €</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" class="text-end">Total :</th>
            <th class="text-end">{{ "%.2f"|format(ns.total_price) }} €</th>
          </tr>
        </tfoot>
      </table>
    </div>
</div>
{% endif %}

{% if photos %}
<div class="info-card">
  <h5>Photos</h5>
    <div class="row g-3">
      {% for photo in photos %}
      <div class="col-md-4 col-lg-3">
        <div class="card">
          <a href="{{ url_for('view_maintenance_photo', photo_id=photo.id) }}" target="_blank">
            <img src="{{ url_for('view_maintenance_photo', photo_id=photo.id) }}" 
                 class="card-img-top" 
                 alt="{{ photo.original_filename }}"
                 style="height: 200px; object-fit: cover; cursor: pointer;" />
          </a>
          <div class="card-body p-2">
            <small class="text-muted d-block">{{ photo.original_filename }}</small>
            <small class="text-muted d-block">{{ photo.uploaded_at.strftime("%d/%m/%Y %H:%M") }}</small>
            {% if current_user.user_type == 'admin' or (current_user.user_type == 'technicien' and photo.user_id == current_user.id) %}
            <form method="post" action="{{ url_for('delete_maintenance_photo', photo_id=photo.id) }}" 
                  class="mt-2" 
                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette photo ?');">
              <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}


            <small class="text-muted d-block">{{ photo.uploaded_at.strftime("%d/%m/%Y %H:%M") }}</small>
            {% if current_user.user_type == 'admin' or (current_user.user_type == 'technicien' and photo.user_id == current_user.id) %}
            <form method="post" action="{{ url_for('delete_maintenance_photo', photo_id=photo.id) }}" 
                  class="mt-2" 
                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette photo ?');">
              <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

