{% extends "base.html" %}
{% block title %}Maintenances corrective - {{ maintenance.machine.name }}{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .info-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .info-card h5 {
    color: #1a3b50;
    font-weight: 600;
    margin-bottom: 1rem;
  }
  .btn-outline-primary {
    border-color: #1a3b50;
    color: #1a3b50;
  }
  .btn-outline-primary:hover {
    background-color: #1a3b50;
    color: white;
  }
  .table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  .table thead th {
    color: #1a3b50;
    font-weight: 600;
    border-bottom: 2px solid #1a3b50;
    background: #f8f9fa;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }
    
    .btn-outline-primary {
      width: 100%;
    }
    
    .info-card {
      padding: 1rem;
    }
    
    .row.g-3 > [class*="col-"] {
      margin-bottom: 1rem;
    }
    
    .table-responsive {
      font-size: 0.875rem;
    }
    
    .table th, .table td {
      padding: 0.5rem 0.25rem;
    }
  }
  
  @media (max-width: 576px) {
    .info-card {
      padding: 0.75rem;
    }
    
    .row.g-3 > [class*="col-"] {
      flex: 0 0 100%;
      max-width: 100%;
    }
    
    .table th, .table td {
      padding: 0.375rem 0.125rem;
      font-size: 0.8rem;
    }
  }
</style>

<div class="page-header">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item"><a href="{{ url_for('machines') }}">Machines</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('machine_detail', machine_id=maintenance.machine.id) }}">{{ maintenance.machine.name }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Maintenances corrective</li>
    </ol>
  </nav>
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="page-title">Maintenances corrective</h1>
      <p class="text-muted mb-0 mt-2">
        Machine : <a href="{{ url_for('machine_detail', machine_id=maintenance.machine.id) }}">{{ maintenance.machine.name }} ({{ maintenance.machine.code }})</a>
      </p>
    </div>
    {% if current_user.user_type == 'admin' or (current_user.user_type == 'technicien' and maintenance.user_id == current_user.id) %}
    <a class="btn btn-outline-primary" href="{{ url_for('edit_corrective_maintenance', maintenance_id=maintenance.id) }}" title="Modifier le rapport"><img src="{{ url_for('static', filename='icons/edit.svg') }}" alt="Modifier" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></a>
    {% endif %}
  </div>
</div>

<div class="info-card">
  <h5>Informations</h5>
    <div class="row g-3">
      <div class="col-md-4 col-lg-3">
        <strong>Date et heure :</strong><br>
        <span class="text-muted">{{ maintenance.created_at.strftime("%d/%m/%Y %H:%M") }}</span>
      </div>
      {% if maintenance.hours %}
      <div class="col-md-4 col-lg-3">
        <strong>Nombre d'heures :</strong><br>
        <span class="text-muted">{{ "%.1f"|format(maintenance.hours) }} h</span>
      </div>
      {% endif %}
      {% if maintenance.stock %}
      <div class="col-md-4 col-lg-3">
        <strong>Stock :</strong><br>
        <span class="text-muted">{{ maintenance.stock.name }} ({{ maintenance.stock.code }})</span>
      </div>
      {% endif %}
      {% if maintenance.comment %}
      <div class="col-md-12 col-lg-6">
        <strong>Commentaire :</strong><br>
        <span class="text-muted">{{ maintenance.comment }}</span>
      </div>
      {% endif %}
    </div>
</div>

{% if maintenance.products %}
<div class="info-card">
  <h5>Produits utilisés</h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Produit</th>
            <th>Code</th>
            <th>Quantité</th>
            <th class="text-end">Prix unitaire</th>
            <th class="text-end">Prix total</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(total_price=0.0) %}
          {% for product_item in maintenance.products %}
          {% set line_total = product_item.product.price * product_item.quantity %}
          {% set ns.total_price = ns.total_price + line_total %}
          <tr>
            <td>{{ product_item.product.name }}</td>
            <td>{{ product_item.product.code }}</td>
            <td>{{ product_item.quantity }}</td>
            <td class="text-end">{{ "%.2f"|format(product_item.product.price) }} €</td>
            <td class="text-end fw-bold">{{ "%.2f"|format(line_total) }} €</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" class="text-end">Total :</th>
            <th class="text-end">{{ "%.2f"|format(ns.total_price) }} €</th>
          </tr>
        </tfoot>
      </table>
    </div>
</div>
{% endif %}

{% if photos %}
<div class="info-card">
  <h5>Photos</h5>
    <div class="row g-3">
      {% for photo in photos %}
      <div class="col-md-4 col-lg-3">
        <div class="card">
          <a href="{{ url_for('view_maintenance_photo', photo_id=photo.id) }}" target="_blank">
            <img src="{{ url_for('view_maintenance_photo', photo_id=photo.id) }}" 
                 class="card-img-top" 
                 alt="{{ photo.original_filename }}"
                 style="height: 200px; object-fit: cover; cursor: pointer;" />
          </a>
          <div class="card-body p-2">
            <small class="text-muted d-block">{{ photo.original_filename }}</small>
            <small class="text-muted d-block">{{ photo.uploaded_at.strftime("%d/%m/%Y %H:%M") }}</small>
            {% if current_user.user_type == 'admin' or (current_user.user_type == 'technicien' and photo.user_id == current_user.id) %}
            <form method="post" action="{{ url_for('delete_maintenance_photo', photo_id=photo.id) }}" 
                  class="mt-2" 
                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette photo ?');">
              <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

