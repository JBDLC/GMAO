{% extends "base.html" %}
{% block title %}Liste des maintenances{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  .table thead th {
    color: #1a3b50;
    font-weight: 600;
    border-bottom: 2px solid #1a3b50;
    background: #f8f9fa;
  }
  .form-control-sm, .form-select-sm {
    border-color: #ced4da;
  }
  .form-control-sm:focus, .form-select-sm:focus {
    border-color: #1a3b50;
    box-shadow: 0 0 0 0.25rem rgba(26, 59, 80, 0.25);
  }
  .btn-success {
    background-color: #1a3b50;
    border-color: #1a3b50;
    color: white;
    font-weight: 600;
  }
  .btn-success:hover {
    background-color: #03192f;
    border-color: #03192f;
    color: white;
  }
  .btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
  }
  .btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
  }
  .alert-info {
    background-color: #e3f2fd;
    border-color: #1a3b50;
    color: #1a3b50;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }
    
    .btn-group {
      flex-direction: column;
      width: 100%;
    }
    
    .btn-group > * {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .table-responsive {
      font-size: 0.8rem;
    }
    
    .table th, .table td {
      padding: 0.5rem 0.25rem;
    }
    
    .form-control-sm, .form-select-sm {
      font-size: 0.8rem;
    }
  }
  
  @media (max-width: 576px) {
    .table th, .table td {
      padding: 0.375rem 0.125rem;
      font-size: 0.75rem;
    }
    
    /* Masquer certaines colonnes sur tr√®s petits √©crans */
    .table th:nth-child(5),
    .table td:nth-child(5) {
      display: none;
    }
  }
</style>

<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="page-title">Liste des maintenances</h1>
  <div class="btn-group">
    <a href="{{ url_for('maintenances_list') }}" class="btn btn-outline-secondary btn-sm">R√©initialiser les filtres</a>
    <a href="{{ url_for('export_maintenances', filter_type=filter_type, filter_name=filter_name, filter_date=filter_date, filter_machine=filter_machine, filter_user=filter_user) }}" class="btn btn-success btn-sm" title="Exporter en Excel">üìä Export Excel</a>
  </div>
</div>

{% if maintenances %}
<div class="table-responsive mt-3">
  <table class="table table-hover align-middle" style="font-size: 0.875rem;">
    <thead class="table-light">
      <tr>
        <th style="width: 120px;">Type</th>
        <th>Nom</th>
        <th style="width: 150px;">Date</th>
        <th>Machine / Sous-machine</th>
        <th style="width: 150px;">Identifiant</th>
      </tr>
      <tr>
        <th>
          <select class="form-select form-select-sm" name="filter_type" id="filter_type">
            <option value="">Tous</option>
            <option value="pr√©ventive" {% if filter_type == 'pr√©ventive' %}selected{% endif %}>Pr√©ventive</option>
            <option value="corrective" {% if filter_type == 'corrective' %}selected{% endif %}>Corrective</option>
          </select>
        </th>
        <th>
          <input type="text" class="form-control form-control-sm" name="filter_name" id="filter_name" 
                 placeholder="Rechercher..." value="{{ filter_name }}">
        </th>
        <th>
          <input type="date" class="form-control form-control-sm" name="filter_date" id="filter_date" 
                 value="{{ filter_date }}">
        </th>
        <th>
          <input type="text" class="form-control form-control-sm" name="filter_machine" id="filter_machine" 
                 placeholder="Rechercher..." value="{{ filter_machine }}">
        </th>
        <th>
          <input type="text" class="form-control form-control-sm" name="filter_user" id="filter_user" 
                 placeholder="Rechercher..." value="{{ filter_user }}">
        </th>
      </tr>
    </thead>
    <tbody>
      {% for maintenance in maintenances %}
      <tr>
        <td>
          <span class="badge bg-{{ maintenance.type_badge }}">{{ maintenance.type|title }}</span>
        </td>
        <td>
          <a href="{{ maintenance.url }}" class="text-decoration-none fw-semibold">{{ maintenance.name }}</a>
        </td>
        <td>{{ maintenance.date.strftime("%d/%m/%Y %H:%M") }}</td>
        <td>
          {% set lineage = machine_lineage(maintenance.machine) %}
          {% for node in lineage %}
            {% if loop.last %}
              <strong>{{ node.name }}</strong>
              {% if node.code %}
              <span class="text-muted">({{ node.code }})</span>
              {% endif %}
            {% else %}
              <a href="{{ url_for('machine_detail', machine_id=node.id) }}" class="text-decoration-none">{{ node.name }}</a>
              <span class="text-muted"> ‚Ä∫ </span>
            {% endif %}
          {% endfor %}
        </td>
        <td>
          {% if maintenance.user %}
          <span class="text-muted">{{ maintenance.user.username }}</span>
          {% else %}
          <span class="text-muted fst-italic">Non renseign√©</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">
  <p class="mb-0">Aucune maintenance enregistr√©e{% if filter_type or filter_name or filter_date or filter_machine or filter_user %} correspondant aux filtres{% endif %}.</p>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
let filterTimeout;
function applyFilters() {
  clearTimeout(filterTimeout);
  filterTimeout = setTimeout(() => {
    const params = new URLSearchParams();
    
    const filterType = document.getElementById('filter_type').value;
    const filterName = document.getElementById('filter_name').value;
    const filterDate = document.getElementById('filter_date').value;
    const filterMachine = document.getElementById('filter_machine').value;
    const filterUser = document.getElementById('filter_user').value;
    
    if (filterType) params.set('filter_type', filterType);
    if (filterName) params.set('filter_name', filterName);
    if (filterDate) params.set('filter_date', filterDate);
    if (filterMachine) params.set('filter_machine', filterMachine);
    if (filterUser) params.set('filter_user', filterUser);
    
    const queryString = params.toString();
    window.location.href = '{{ url_for("maintenances_list") }}' + (queryString ? '?' + queryString : '');
  }, 500); // D√©lai de 500ms pour les champs texte
}

// Pour les champs texte, utiliser un d√©lai, pour les autres appliquer imm√©diatement
document.getElementById('filter_name').addEventListener('keyup', applyFilters);
document.getElementById('filter_machine').addEventListener('keyup', applyFilters);
document.getElementById('filter_user').addEventListener('keyup', applyFilters);
document.getElementById('filter_type').addEventListener('change', () => {
  clearTimeout(filterTimeout);
  applyFilters();
});
document.getElementById('filter_date').addEventListener('change', () => {
  clearTimeout(filterTimeout);
  applyFilters();
});
</script>
{% endblock %}

