{% extends "base.html" %}
{% block title %}{{ machine.name }}{% endblock %}
{% block content %}
<!-- Arborescence moderne -->
<div class="card mb-4 border-0 shadow-sm">
  <div class="card-body py-3">
    <nav aria-label="breadcrumb" class="mb-2">
      <ol class="breadcrumb mb-0" style="--bs-breadcrumb-divider: '‚Ä∫';">
        <li class="breadcrumb-item">
          <a href="{{ url_for('machines') }}" class="text-decoration-none">{{ t('Machines') }}</a>
        </li>
        {% for node in machine_lineage(machine) %}
          {% if loop.last %}
          <li class="breadcrumb-item active" aria-current="page">
            <strong>{{ node.name }}</strong>
            {% if node.code %}
            <span class="text-muted ms-1">({{ node.code }})</span>
            {% endif %}
          </li>
          {% else %}
          <li class="breadcrumb-item">
            <a href="{{ url_for('machine_detail', machine_id=node.id) }}" class="text-decoration-none">{{ node.name }}</a>
          </li>
          {% endif %}
        {% endfor %}
      </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-0">{{ machine.name }}</h2>
        {% if machine.is_root() and machine.counters %}
        <p class="text-muted mb-0 mt-1">
          {% for counter in machine.counters %}
          <span class="badge bg-info me-1">{{ counter.name }}: {{ "%.1f"|format(counter.value) }} {{ counter.unit or 'h' }}</span>
          {% endfor %}
        </p>
        {% elif machine.hour_counter_enabled %}
        <p class="text-muted mb-0 mt-1">
          <span class="badge bg-info">{{ "%.1f"|format(machine.hours) }} {{ machine.counter_unit or 'h' }}</span>
        </p>
        {% endif %}
      </div>
      <div class="btn-group">
        <a href="{{ url_for('machine_qrcode', machine_id=machine.id) }}" class="btn btn-outline-secondary" title="{{ t('Voir le QR code') }}" target="_blank">üì± {{ t('QR Code') }}</a>
        {% if current_user.user_type == 'admin' %}
        {% if machine.hour_counter_enabled or (machine.is_root() and machine.counters) %}
        <a href="{{ url_for('counter_report', machine_id=machine.id) }}" class="btn btn-outline-info" title="{{ t('Relev√© de compteur') }}">üìä {{ t('Relev√©') }}</a>
        {% endif %}
        {% if machine.is_root() %}
        <a href="{{ url_for('machine_counters', machine_id=machine.id) }}" class="btn btn-outline-info" title="{{ t('G√©rer les compteurs') }}">‚öôÔ∏è {{ t('Compteurs') }}</a>
        {% endif %}
        <a href="{{ url_for('edit_machine', machine_id=machine.id) }}" class="btn btn-outline-primary" title="{{ t('Modifier') }}">‚úèÔ∏è</a>
        <form method="post" action="{{ url_for('delete_machine', machine_id=machine.id) }}" class="d-inline" onsubmit="return confirm('{{ t('√ätes-vous s√ªr de vouloir supprimer cette machine ? Cette action est irr√©versible.') }}');">
          <button type="submit" class="btn btn-outline-danger" title="{{ t('Supprimer') }}">üóëÔ∏è</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Sous-machines -->
{% if children %}
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">{{ t('Sous-machines') }}</h5>
  </div>
  <div class="card-body">
    <div class="list-group list-group-flush">
      {% for child in children %}
      <div class="list-group-item d-flex justify-content-between align-items-center" style="font-size: 0.875rem;">
        <a href="{{ url_for('machine_detail', machine_id=child.id) }}" class="text-decoration-none flex-grow-1">
          <div>
            <strong style="font-size: 0.875rem;">{{ child.name }}</strong>
            <div class="text-muted" style="font-size: 0.75rem;">{{ child.code }}</div>
          </div>
        </a>
        <div class="d-flex align-items-center">
          {% if child.hour_counter_enabled %}
          <span class="badge bg-info me-2">{{ "%.1f"|format(child.hours) }} {{ child.counter_unit or 'h' }}</span>
          {% endif %}
          {% if current_user.user_type == 'admin' %}
          <div class="btn-group">
            <a href="{{ url_for('edit_machine', machine_id=child.id) }}" class="btn btn-sm btn-outline-primary" title="{{ t('Modifier') }}">‚úèÔ∏è</a>
            <form method="post" action="{{ url_for('delete_machine', machine_id=child.id) }}" class="d-inline" onsubmit="return confirm('{{ t('√ätes-vous s√ªr de vouloir supprimer cette sous-machine ? Cette action est irr√©versible.') }}');">
              <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ t('Supprimer') }}">üóëÔ∏è</button>
            </form>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- Onglets -->
<div class="card mb-4">
  <div class="card-header p-0">
    <ul class="nav nav-tabs card-header-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'checklists' %}active{% endif %}" id="checklists-tab" data-bs-toggle="tab" data-bs-target="#checklists" type="button" role="tab" aria-controls="checklists" aria-selected="{% if active_tab == 'checklists' %}true{% else %}false{% endif %}" data-tab="checklists">
          {{ t('Check-list') }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'corrective' %}active{% endif %}" id="corrective-tab" data-bs-toggle="tab" data-bs-target="#corrective" type="button" role="tab" aria-controls="corrective" aria-selected="{% if active_tab == 'corrective' %}true{% else %}false{% endif %}" data-tab="corrective">
          {{ t('Maintenance corrective') }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'preventive' %}active{% endif %}" id="preventive-tab" data-bs-toggle="tab" data-bs-target="#preventive" type="button" role="tab" aria-controls="preventive" aria-selected="{% if active_tab == 'preventive' %}true{% else %}false{% endif %}" data-tab="preventive">
          {{ t('Maintenance pr√©ventive') }}
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'documentation' %}active{% endif %}" id="documentation-tab" data-bs-toggle="tab" data-bs-target="#documentation" type="button" role="tab" aria-controls="documentation" aria-selected="{% if active_tab == 'documentation' %}true{% else %}false{% endif %}" data-tab="documentation">
          {{ t('Documentation') }}
        </button>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content" id="machineTabsContent">
      <!-- Onglet 1: Check lists -->
      <div class="tab-pane fade {% if active_tab == 'checklists' %}show active{% endif %}" id="checklists" role="tabpanel" aria-labelledby="checklists-tab">
        <!-- Mod√®les de check lists -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ t('Mod√®les de check lists') }}</h5>
            {% if current_user.user_type == 'admin' %}
            <a href="{{ url_for('new_checklist_template', machine_id=machine.id) }}" class="btn btn-sm btn-primary">
              + {{ t('Nouvelle check list') }}
            </a>
            {% endif %}
          </div>
          <div class="card-body">
            {% if checklist_templates %}
            <div class="row g-3">
              {% for template in checklist_templates %}
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title">{{ template.name }}</h6>
                    <p class="card-text small text-muted mb-2">
                      {{ template.items|length }} {{ t('√©l√©ment(s)') }}
                      {% if template.instances %}
                      ¬∑ {{ template.instances|length }} {{ t('remplissage(s)') }}
                      {% endif %}
                    </p>
                    <div class="btn-group w-100" role="group">
                      {% if current_user.user_type in ['admin', 'technicien'] %}
                      <a href="{{ url_for('fill_checklist', machine_id=machine.id, template_id=template.id) }}" class="btn btn-success btn-sm">{{ t('Remplir') }}</a>
                      {% endif %}
                      {% if template.instances %}
                      <a href="{{ url_for('checklist_instances_list', machine_id=machine.id, template_id=template.id) }}" class="btn btn-outline-info btn-sm">{{ t('Historique') }}</a>
                      {% endif %}
                      {% if current_user.user_type == 'admin' %}
                      <a href="{{ url_for('edit_checklist_template', machine_id=machine.id, template_id=template.id) }}" class="btn btn-outline-primary btn-sm">‚úèÔ∏è</a>
                      <form method="post" action="{{ url_for('delete_checklist_template', machine_id=machine.id, template_id=template.id) }}" class="d-inline" onsubmit="return confirm('{{ t('√ätes-vous s√ªr de vouloir supprimer cette check list ?') }}');">
                        <button type="submit" class="btn btn-outline-danger btn-sm">üóëÔ∏è</button>
                      </form>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0 text-center py-3">{{ t('Aucune check list disponible pour cette machine.') }}</p>
            {% if current_user.user_type == 'admin' %}
            <div class="text-center">
              <a href="{{ url_for('new_checklist_template', machine_id=machine.id) }}" class="btn btn-primary">{{ t('Cr√©er une check list') }}</a>
            </div>
            {% endif %}
            {% endif %}
          </div>
        </div>

        <!-- Historique des check lists remplies -->
        {% if checklist_instances %}
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ t('Check lists effectu√©es') }}</h5>
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              {% for instance in checklist_instances %}
              <a href="{{ url_for('checklist_instance_detail', machine_id=machine.id, template_id=instance.template_id, instance_id=instance.id) }}" class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <strong>{{ instance.template.name }}</strong>
                    {% if instance.comment %}
                    <div class="text-muted small mt-1">
                      {{ instance.comment[:80] }}{% if instance.comment|length > 80 %}...{% endif %}
                    </div>
                    {% endif %}
                  </div>
                  <small class="text-muted text-end">
                    {{ instance.created_at.strftime("%d/%m/%Y %H:%M") }}<br />
                    {% if instance.user %}
                    {{ instance.user.username }}
                    {% endif %}
                  </small>
                </div>
              </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Onglet 2: Maintenance corrective -->
      <div class="tab-pane fade {% if active_tab == 'corrective' %}show active{% endif %}" id="corrective" role="tabpanel" aria-labelledby="corrective-tab">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ t('Maintenances correctives') }}</h5>
            <a class="btn btn-sm btn-warning" href="{{ url_for('new_corrective_maintenance', machine_id=machine.id) }}">
              + Nouvelle
            </a>
          </div>
          <div class="card-body">
            {% if corrective_maintenances %}
            <div class="list-group list-group-flush">
              {% for maintenance in corrective_maintenances %}
              <a class="list-group-item list-group-item-action" href="{{ url_for('corrective_maintenance_detail', maintenance_id=maintenance.id) }}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <strong>Maintenance corrective</strong>
                    <div class="text-muted small mt-1">
                      {% if maintenance.stock %}
                      <span class="badge bg-info">Stock : {{ maintenance.stock.name }}</span>
                      {% endif %}
                    </div>
                  </div>
                  <small class="text-muted">
                    {{ maintenance.created_at.strftime("%d/%m/%Y %H:%M") }}
                    {% if maintenance.user %}
                    ¬∑ {{ maintenance.user.username }}
                    {% endif %}
                  </small>
                </div>
              </a>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0 text-center py-3">{{ t('Aucune maintenance corrective enregistr√©e') }} pour cette machine.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Onglet 3: Maintenance pr√©ventive -->
      <div class="tab-pane fade {% if active_tab == 'preventive' %}show active{% endif %}" id="preventive" role="tabpanel" aria-labelledby="preventive-tab">
        {% set has_own_counter = machine.hour_counter_enabled %}
        {% set has_root_counters = root_machine.is_root() and root_machine.counters %}
        {% if has_own_counter or has_root_counters %}
        <!-- Maintenances disponibles -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ t('Maintenances disponibles') }}</h5>
            {% if current_user.user_type == 'admin' %}
            <a class="btn btn-sm btn-primary" href="{{ url_for('new_maintenance', machine_id=machine.id) }}">
              + Nouveau mod√®le
            </a>
            {% endif %}
          </div>
          <div class="card-body">
            {% if templates %}
            <div class="row g-3">
              {% for item in template_progress %}
              {% set report = item.report %}
              {% set hours_remaining = item.hours_since %}
              <div class="col-md-6">
                <div class="card {% if hours_remaining <= 0 %}border-danger{% elif hours_remaining <= report.periodicity * 0.1 %}border-warning{% else %}border-secondary{% endif %}">
                  <div class="card-body">
                    <h6 class="card-title">{{ report.name }}</h6>
                    <div class="mb-2">
                      <span class="badge bg-secondary me-1">{{ report.periodicity }} h</span>
                      <span class="badge bg-info me-1">{{ report.components|length }} √©l√©ments</span>
                      {% if hours_remaining <= 0 %}
                      <span class="badge bg-danger">En retard</span>
                      {% elif hours_remaining <= report.periodicity * 0.1 %}
                      <span class="badge bg-warning">Proche</span>
                      {% endif %}
                    </div>
                    <p class="card-text small text-muted mb-2">
                      <strong>Avant maintenance :</strong>
                      {% set unit = machine.counter_unit or 'h' %}
                      {% if hours_remaining < 0 %}
                      <span class="text-danger">{{ "%.1f"|format(hours_remaining) }} {{ unit }} (retard)</span>
                      {% elif hours_remaining == 0 %}
                      <span class="text-danger">0 {{ unit }} (due)</span>
                      {% else %}
                      <span>{{ "%.1f"|format(hours_remaining) }} {{ unit }}</span>
                      {% endif %}
                    </p>
                  <div class="btn-group w-100" role="group">
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('maintenance_detail', report_id=report.id) }}">Voir</a>
                    {% if current_user.user_type in ['admin', 'technicien'] %}
                    <a class="btn btn-success btn-sm" href="{{ url_for('fill_maintenance', machine_id=machine.id, report_id=report.id) }}">Remplir</a>
                    {% endif %}
                  </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
              <p class="text-muted mb-3">{{ t('Aucune maintenance disponible') }}</p>
              <a class="btn btn-primary" href="{{ url_for('new_maintenance', machine_id=machine.id) }}">Cr√©er un mod√®le</a>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Maintenances pr√©ventives effectu√©es -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ t('Maintenances pr√©ventives effectu√©es') }}</h5>
          </div>
          <div class="card-body">
            {% if entries %}
            <div class="list-group list-group-flush">
              {% for entry in entries %}
              <a class="list-group-item list-group-item-action" href="{{ url_for('maintenance_entry_detail', entry_id=entry.id) }}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <strong>{{ entry.report.name }}</strong>
                    <div class="text-muted small mt-1">
                      {% if entry.stock %}
                      <span class="badge bg-info">Stock : {{ entry.stock.name }}</span>
                      {% endif %}
                    </div>
                  </div>
                  <small class="text-muted">
                    {{ entry.created_at.strftime("%d/%m/%Y %H:%M") }}
                    {% if entry.user %}
                    ¬∑ {{ entry.user.username }}
                    {% endif %}
                  </small>
                </div>
              </a>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0 text-center py-3">{{ t('Aucune maintenance pr√©ventive enregistr√©e') }} pour cette machine.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Onglet 4: Documentation -->
      <div class="tab-pane fade {% if active_tab == 'documentation' %}show active{% endif %}" id="documentation" role="tabpanel" aria-labelledby="documentation-tab">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Documentation</h5>
            {% if current_user.user_type == 'admin' %}
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
              + {{ t('Ajouter un document') }}
            </button>
            {% endif %}
          </div>
          <div class="card-body">
            {% if documents %}
            <div class="list-group list-group-flush">
              {% for document in documents %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{{ url_for('download_machine_document', machine_id=machine.id, document_id=document.id) }}" target="_blank" class="text-decoration-none flex-grow-1">
                  <div>
                    <strong>üìÑ {{ document.original_filename }}</strong>
                    <div class="text-muted small mt-1">
                      Ajout√© le {{ document.uploaded_at.strftime("%d/%m/%Y %H:%M") }}
                      {% if document.user %}
                      par {{ document.user.username }}
                      {% endif %}
                    </div>
                  </div>
                </a>
                {% if current_user.user_type == 'admin' %}
                <form method="post" action="{{ url_for('delete_machine_document', machine_id=machine.id, document_id=document.id) }}" class="d-inline" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer ce document ?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Supprimer">üóëÔ∏è</button>
                </form>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0 text-center py-3">{{ t('Aucun document disponible') }} pour cette machine.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour uploader un document -->
{% if current_user.user_type == 'admin' %}
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadDocumentModalLabel">{{ t('Ajouter un document') }} PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('upload_machine_document', machine_id=machine.id) }}" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label for="documentFile" class="form-label">Fichier PDF</label>
            <input type="file" class="form-control" id="documentFile" name="file" accept=".pdf" required />
            <div class="form-text">Seuls les fichiers PDF sont accept√©s.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Uploader</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
<style>
  /* R√©duction de la hauteur des cartes checklist et maintenance */
  #checklists .card-body,
  #preventive .card-body {
    padding: 0.75rem;
  }
  
  #checklists .card-title,
  #preventive .card-title {
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }
  
  #checklists .card-text,
  #preventive .card-text {
    margin-bottom: 0.5rem;
  }
  
  #checklists .mb-2,
  #preventive .mb-2 {
    margin-bottom: 0.5rem !important;
  }
  
  #checklists .btn-group,
  #preventive .btn-group {
    margin-top: 0.5rem;
  }
  
  /* Responsive pour machine_detail */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }
    
    .btn-group {
      flex-direction: column;
      width: 100%;
    }
    
    .btn-group > * {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .card-body {
      padding: 1rem;
    }
    
    .list-group-item {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 0.5rem;
    }
    
    .list-group-item .d-flex {
      width: 100%;
      justify-content: space-between;
    }
    
    .row.g-3 > [class*="col-md-"] {
      flex: 0 0 100%;
      max-width: 100%;
      margin-bottom: 1rem;
    }
    
    .nav-tabs {
      flex-wrap: wrap;
    }
    
    .nav-tabs .nav-link {
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }
    
    .table-responsive {
      font-size: 0.875rem;
    }
    
    .table th, .table td {
      padding: 0.5rem 0.25rem;
    }
    
    .modal-dialog {
      margin: 0.5rem;
    }
    
    .breadcrumb {
      font-size: 0.875rem;
      overflow-x: auto;
      white-space: nowrap;
    }
  }
  
  @media (max-width: 576px) {
    h2 {
      font-size: 1.5rem;
    }
    
    .card-body {
      padding: 0.75rem;
    }
    
    .table th, .table td {
      padding: 0.375rem 0.125rem;
      font-size: 0.8rem;
    }
    
    .badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
    }
  }
</style>
<script>
  // Mettre √† jour l'URL avec le param√®tre tab quand on clique sur un onglet
  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('[data-tab]');
    tabButtons.forEach(function(button) {
      button.addEventListener('shown.bs.tab', function(event) {
        const tab = event.target.getAttribute('data-tab');
        const url = new URL(window.location);
        url.searchParams.set('tab', tab);
        // Mettre √† jour l'URL sans recharger la page
        window.history.pushState({}, '', url);
      });
    });
  });
</script>
{% endblock %}
