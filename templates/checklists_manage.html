{% extends "base.html" %}
{% block title %}Check lists{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  .table thead th {
    color: #1a3b50;
    font-weight: 600;
    border-bottom: 2px solid #1a3b50;
    background: #f8f9fa;
  }
  .form-control {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
  }
  .form-control:focus {
    border-color: #1a3b50;
    box-shadow: 0 0 0 0.25rem rgba(26, 59, 80, 0.25);
    outline: none;
  }
  .btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
  }
  .btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .d-flex.justify-content-between {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start !important;
    }
    
    .btn-group {
      flex-direction: column;
      width: 100%;
    }
    
    .btn-group > * {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .table-responsive {
      font-size: 0.8rem;
    }
    
    .table th, .table td {
      padding: 0.5rem 0.25rem;
    }
    
    .form-control-sm {
      font-size: 0.8rem;
    }
  }
  
  @media (max-width: 576px) {
    .table th, .table td {
      padding: 0.375rem 0.125rem;
      font-size: 0.75rem;
    }
    
    .table th:nth-child(4),
    .table td:nth-child(4) {
      display: none;
    }
  }
</style>

<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="page-title">Check lists</h1>
  <div class="btn-group">
    <a href="{{ url_for('checklists_manage') }}" class="btn btn-outline-secondary btn-sm">Réinitialiser les filtres</a>
  </div>
</div>

{% if checklists %}
<div class="table-responsive mt-3">
  <table class="table table-hover align-middle" style="font-size: 0.875rem;">
    <thead class="table-light">
      <tr>
        <th>Nom</th>
        <th style="width: 150px;">Date</th>
        <th>Machine / Sous-machine</th>
        <th style="width: 150px;">Utilisateur</th>
      </tr>
      <tr>
        <th>
          <input type="text" class="form-control form-control-sm" name="filter_name" id="filter_name" 
                 placeholder="Rechercher..." value="{{ filter_name }}">
        </th>
        <th>
          <input type="date" class="form-control form-control-sm" name="filter_date" id="filter_date" 
                 value="{{ filter_date }}">
        </th>
        <th>
          <input type="text" class="form-control form-control-sm" name="filter_machine" id="filter_machine" 
                 placeholder="Rechercher..." value="{{ filter_machine }}">
        </th>
        <th>
          <input type="text" class="form-control form-control-sm" name="filter_user" id="filter_user" 
                 placeholder="Rechercher..." value="{{ filter_user }}">
        </th>
      </tr>
    </thead>
    <tbody>
      {% for checklist in checklists %}
      <tr>
        <td>
          <a href="{{ checklist.url }}" class="text-decoration-none fw-semibold">{{ checklist.name }}</a>
        </td>
        <td>{{ checklist.date.strftime("%d/%m/%Y %H:%M") }}</td>
        <td>
          {% set lineage = machine_lineage(checklist.machine) %}
          {% for node in lineage %}
            {% if loop.last %}
              <strong>{{ node.name }}</strong>
              {% if node.code %}
              <span class="text-muted">({{ node.code }})</span>
              {% endif %}
            {% else %}
              <a href="{{ url_for('machine_detail', machine_id=node.id) }}" class="text-decoration-none">{{ node.name }}</a>
              <span class="text-muted"> › </span>
            {% endif %}
          {% endfor %}
        </td>
        <td>
          {% if checklist.user %}
          <span class="text-muted">{{ checklist.user.username }}</span>
          {% else %}
          <span class="text-muted fst-italic">Non renseigné</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">
  <p class="mb-0">Aucune checklist enregistrée{% if filter_name or filter_date or filter_machine or filter_user %} correspondant aux filtres{% endif %}.</p>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
let filterTimeout;
function applyFilters() {
  clearTimeout(filterTimeout);
  filterTimeout = setTimeout(() => {
    const params = new URLSearchParams();
    
    const filterName = document.getElementById('filter_name').value;
    const filterDate = document.getElementById('filter_date').value;
    const filterMachine = document.getElementById('filter_machine').value;
    const filterUser = document.getElementById('filter_user').value;
    
    if (filterName) params.set('filter_name', filterName);
    if (filterDate) params.set('filter_date', filterDate);
    if (filterMachine) params.set('filter_machine', filterMachine);
    if (filterUser) params.set('filter_user', filterUser);
    
    const queryString = params.toString();
    window.location.href = '{{ url_for("checklists_manage") }}' + (queryString ? '?' + queryString : '');
  }, 500); // Délai de 500ms pour les champs texte
}

// Pour les champs texte, utiliser un délai, pour les autres appliquer immédiatement
document.getElementById('filter_name').addEventListener('keyup', applyFilters);
document.getElementById('filter_machine').addEventListener('keyup', applyFilters);
document.getElementById('filter_user').addEventListener('keyup', applyFilters);
document.getElementById('filter_date').addEventListener('change', () => {
  clearTimeout(filterTimeout);
  applyFilters();
});
</script>
{% endblock %}

