{% extends "base.html" %}
{% block title %}Accueil-FMS{% endblock %}

{% macro render_machine_node(node, level, color_index) %}
  {% set has_children = node.children|length > 0 %}
  {% set is_followed = node.id in followed_machine_ids %}
  
  <div class="machine-node tree-level-{{ level }} machine-color-{{ color_index }} {% if not is_followed %}not-followed machine-not-followed{% endif %}" data-machine-id="{{ node.id }}" {% if not is_followed %}style="display: none;"{% endif %}>
    <div class="machine-content">
      <button 
        type="button" 
        class="machine-toggle {% if not has_children %}no-children{% endif %}" 
        data-target="{{ node.id }}"
        data-machine-id="{{ node.id }}">
        {% if has_children %}+{% endif %}
      </button>
      
      {% set status = machine_status.get(node.id) %}
      <span class="machine-status {% if status == 'danger' %}danger{% elif status == 'warning' %}warning{% endif %}"></span>
      
        <div class="machine-info">
        <a href="{{ url_for('machine_detail', machine_id=node.id) }}" class="machine-name">
          {{ node.name }} <span class="machine-code">({{ node.code }})</span>
        </a>
        {% if (node.is_root() and node.counters) or node.hour_counter_enabled %}
        <div class="machine-counters-info" style="position: relative; display: inline-block; margin-left: 8px;">
          {% set counters_count = node.counters|length if node.is_root() and node.counters else 1 %}
          <button type="button" class="btn-counter-badge" data-machine-id="{{ node.id }}" title="{{ t('Voir les compteurs') }}">
            {{ counters_count }} {% if counters_count > 1 %}{{ t('compteurs') }}{% else %}{{ t('compteur') }}{% endif %}
          </button>
          <div class="counter-tooltip" id="counter-tooltip-{{ node.id }}" style="display: none;">
            <div class="counter-tooltip-content">
              {% if node.is_root() and node.counters %}
                {% for counter in node.counters %}
                <div class="counter-tooltip-item">
                  <span class="counter-name">{{ counter.name }}:</span>
                  <span class="counter-value">{{ "%.1f"|format(counter.value) }} {{ counter.unit or 'h' }}</span>
                </div>
                {% endfor %}
              {% elif node.hour_counter_enabled %}
              <div class="counter-tooltip-item">
                <span class="counter-name">{{ t('Compteur machine') }}:</span>
                <span class="counter-value">{{ "%.1f"|format(node.hours) }} {{ node.counter_unit or 'h' }}</span>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      
      <div class="machine-actions">
        <button 
          type="button" 
          class="btn-action follow-btn {% if is_followed %}followed{% endif %}" 
          data-machine-id="{{ node.id }}"
          title="{% if is_followed %}{{ t('Ne plus suivre') }}{% else %}{{ t('Suivre cette machine') }}{% endif %}">
          {% if is_followed %}
            <img src="{{ url_for('static', filename='icons/star.svg') }}" alt="{{ t('Suivre cette machine') }}" style="width: 16px; height: 16px; display: inline-block;">
          {% else %}
            <img src="{{ url_for('static', filename='icons/star-outline.svg') }}" alt="{{ t('Suivre cette machine') }}" style="width: 16px; height: 16px; display: inline-block;">
          {% endif %}
        </button>
        {% if level == 0 and current_user.user_type in ['admin', 'technicien'] and has_counter_in_tree(node) %}
        <a href="{{ url_for('counter_report', machine_id=node.id) }}" class="btn-action" title="{{ t('Relevé compteurs') }}">
          <img src="{{ url_for('static', filename='icons/counter.svg') }}" alt="{{ t('Relevé') }}" style="width: 16px; height: 16px;">
        </a>
        {% endif %}
      </div>
    </div>
    
    {% if has_children %}
    <div class="machine-children collapsed" id="children-{{ node.id }}">
      {% for child in node.children|sort(attribute='code') %}
        {{ render_machine_node(child, child.depth(), color_index) }}
      {% endfor %}
    </div>
    {% endif %}
  </div>
{% endmacro %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='machines.css') if False else '' }}">
<style>
  /* Copier les styles de machines.html */
  .machine-tree {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  
  .machine-node {
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    transition: background-color 0.2s ease;
  }
  
  .machine-node:last-child {
    border-bottom: none;
  }
  
  .machine-node:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  .machine-node.not-followed {
    opacity: 0.6;
  }
  
  .machine-content {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    min-height: 56px;
  }
  
  .machine-toggle {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 1px solid #1a3b50;
    background: white;
    color: #1a3b50;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-right: 12px;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  
  .machine-toggle:hover {
    background: #1a3b50;
    color: white;
  }
  
  .machine-toggle.no-children {
    visibility: hidden;
  }
  
  .machine-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 12px;
    flex-shrink: 0;
  }
  
  .machine-status.danger {
    background-color: #dc3545;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
  }
  
  .machine-status.warning {
    background-color: #ffc107;
    box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2);
  }
  
  .machine-info {
    flex-grow: 1;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .machine-name {
    font-weight: 500;
    color: #1a3b50;
    text-decoration: none;
    transition: color 0.2s ease;
  }
  
  .machine-name:hover {
    color: #03192f;
  }
  
  .machine-code {
    color: #6c757d;
    font-size: 0.9em;
  }
  
  .machine-badges {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  
  .badge-counter {
    background-color: #1a3b50;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
  }
  
  .btn-counter-badge {
    background-color: rgba(26, 59, 80, 0.1);
    color: #1a3b50;
    border: 1px solid rgba(26, 59, 80, 0.3);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn-counter-badge:hover {
    background-color: rgba(26, 59, 80, 0.2);
    border-color: rgba(26, 59, 80, 0.5);
  }
  
  .counter-tooltip {
    position: fixed;
    z-index: 99999;
    min-width: 200px;
    pointer-events: none;
  }
  
  .counter-tooltip-content {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 10px;
    pointer-events: auto;
  }
  
  .counter-tooltip-item {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .counter-tooltip-item:last-child {
    border-bottom: none;
  }
  
  .counter-tooltip-item .counter-name {
    font-weight: 500;
    color: #1a3b50;
  }
  
  .counter-tooltip-item .counter-value {
    color: #6c757d;
    font-weight: 600;
  }
  
  /* Flèche du tooltip */
  .counter-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: white;
    pointer-events: none;
  }
  
  .counter-tooltip::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 7px solid transparent;
    border-top-color: #dee2e6;
    margin-top: -1px;
    pointer-events: none;
  }
  
  .machine-actions {
    display: flex;
    gap: 6px;
    margin-left: 12px;
    flex-shrink: 0;
  }
  
  .btn-action {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    background: white;
    color: #1a3b50;
    transition: all 0.2s ease;
    text-decoration: none;
    font-size: 14px;
  }
  
  .btn-action:hover {
    background: #1a3b50;
    color: white;
    border-color: #1a3b50;
  }
  
  .btn-action:hover img {
    filter: brightness(0) invert(1);
  }
  
  .btn-action.follow-btn {
    border-color: #ffc107;
    color: #ffc107;
  }
  
  .btn-action.follow-btn.followed {
    background: #ffc107;
    color: #000;
    border-color: #ffc107;
  }
  
  .btn-action.follow-btn.followed img {
    filter: brightness(0);
  }
  
  .btn-action.follow-btn:hover {
    background: #ffc107;
    color: #000;
    border-color: #ffc107;
  }
  
  .btn-action.follow-btn:hover img {
    filter: brightness(0);
  }
  
  .machine-children {
    margin-left: 24px;
    border-left: 2px solid white;
    overflow: hidden;
  }
  
  .machine-children.collapsed {
    display: none !important;
  }
  
  .machine-children.expanded {
    display: block !important;
  }
  
  /* Palette de 10 couleurs (sans bleu) avec dégradés pour chaque niveau */
  /* Couleur 0 - Vert foncé */
  .machine-color-0.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #2d5016 0%, #1e340f 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-0.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #1e340f 0%, #2d5016 100%);
  }
  .machine-color-0.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #3d7026 0%, #2d5016 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-0.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #2d5016 0%, #3d7026 100%);
  }
  .machine-color-0.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #4d9036 0%, #3d7026 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-0.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #3d7026 0%, #4d9036 100%);
  }
  .machine-color-0.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #5db046 0%, #4d9036 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-0.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #4d9036 0%, #5db046 100%);
  }
  .machine-color-0.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #6dd056 0%, #5db046 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-0.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #5db046 0%, #6dd056 100%);
  }
  
  /* Couleur 1 - Violet */
  .machine-color-1.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-1.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #4a148c 0%, #6a1b9a 100%);
  }
  .machine-color-1.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-1.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #6a1b9a 0%, #7b1fa2 100%);
  }
  .machine-color-1.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-1.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
  }
  .machine-color-1.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #ba68c8 0%, #9c27b0 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-1.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
  }
  .machine-color-1.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-1.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #ba68c8 0%, #ce93d8 100%);
  }
  
  /* Couleur 2 - Orange */
  .machine-color-2.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #e65100 0%, #bf360c 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-2.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #bf360c 0%, #e65100 100%);
  }
  .machine-color-2.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #ff6f00 0%, #e65100 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-2.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #e65100 0%, #ff6f00 100%);
  }
  .machine-color-2.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #ff8f00 0%, #ff6f00 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-2.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #ff6f00 0%, #ff8f00 100%);
  }
  .machine-color-2.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #ffb300 0%, #ff8f00 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-2.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #ff8f00 0%, #ffb300 100%);
  }
  .machine-color-2.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
    color: #1a3b50;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-2.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #ffb300 0%, #ffc107 100%);
  }
  
  /* Couleur 3 - Rouge */
  .machine-color-3.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-3.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
  }
  .machine-color-3.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-3.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #c62828 0%, #e53935 100%);
  }
  .machine-color-3.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-3.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #e53935 0%, #ef5350 100%);
  }
  .machine-color-3.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #e57373 0%, #ef5350 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-3.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #ef5350 0%, #e57373 100%);
  }
  .machine-color-3.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #ef9a9a 0%, #e57373 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-3.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #e57373 0%, #ef9a9a 100%);
  }
  
  /* Couleur 4 - Turquoise */
  .machine-color-4.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #00695c 0%, #004d40 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-4.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #004d40 0%, #00695c 100%);
  }
  .machine-color-4.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-4.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #00695c 0%, #00897b 100%);
  }
  .machine-color-4.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-4.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #00897b 0%, #26a69a 100%);
  }
  .machine-color-4.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #4db6ac 0%, #26a69a 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-4.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #26a69a 0%, #4db6ac 100%);
  }
  .machine-color-4.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #80cbc4 0%, #4db6ac 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-4.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #4db6ac 0%, #80cbc4 100%);
  }
  
  /* Couleur 5 - Rose */
  .machine-color-5.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #c2185b 0%, #880e4f 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-5.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #880e4f 0%, #c2185b 100%);
  }
  .machine-color-5.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-5.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #c2185b 0%, #e91e63 100%);
  }
  .machine-color-5.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #ec407a 0%, #e91e63 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-5.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #e91e63 0%, #ec407a 100%);
  }
  .machine-color-5.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #f06292 0%, #ec407a 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-5.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #ec407a 0%, #f06292 100%);
  }
  .machine-color-5.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #f48fb1 0%, #f06292 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-5.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #f06292 0%, #f48fb1 100%);
  }
  
  /* Couleur 6 - Indigo */
  .machine-color-6.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #283593 0%, #1a237e 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-6.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
  }
  .machine-color-6.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #3949ab 0%, #283593 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-6.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
  }
  .machine-color-6.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-6.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #3949ab 0%, #5c6bc0 100%);
  }
  .machine-color-6.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-6.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #5c6bc0 0%, #7986cb 100%);
  }
  .machine-color-6.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-6.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #7986cb 0%, #9fa8da 100%);
  }
  
  /* Couleur 7 - Marron */
  .machine-color-7.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #5d4037 0%, #3e2723 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-7.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #3e2723 0%, #5d4037 100%);
  }
  .machine-color-7.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #795548 0%, #5d4037 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-7.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #5d4037 0%, #795548 100%);
  }
  .machine-color-7.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #8d6e63 0%, #795548 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-7.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #795548 0%, #8d6e63 100%);
  }
  .machine-color-7.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #a1887f 0%, #8d6e63 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-7.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #8d6e63 0%, #a1887f 100%);
  }
  .machine-color-7.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-7.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #a1887f 0%, #bcaaa4 100%);
  }
  
  /* Couleur 8 - Vert menthe */
  .machine-color-8.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #1b5e20 0%, #0d3e11 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-8.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #0d3e11 0%, #1b5e20 100%);
  }
  .machine-color-8.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #388e3c 0%, #1b5e20 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-8.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #1b5e20 0%, #388e3c 100%);
  }
  .machine-color-8.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-8.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #388e3c 0%, #4caf50 100%);
  }
  .machine-color-8.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-8.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
  }
  .machine-color-8.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-8.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
  }
  
  /* Couleur 9 - Ambre */
  .machine-color-9.tree-level-0 .machine-content {
    background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-9.tree-level-0 .machine-content:hover {
    background: linear-gradient(135deg, #e65100 0%, #f57c00 100%);
  }
  .machine-color-9.tree-level-1 .machine-content {
    padding-left: 40px;
    background: linear-gradient(135deg, #ffa726 0%, #f57c00 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-9.tree-level-1 .machine-content:hover {
    background: linear-gradient(135deg, #f57c00 0%, #ffa726 100%);
  }
  .machine-color-9.tree-level-2 .machine-content {
    padding-left: 56px;
    background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
    color: white;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-9.tree-level-2 .machine-content:hover {
    background: linear-gradient(135deg, #ffa726 0%, #ffb74d 100%);
  }
  .machine-color-9.tree-level-3 .machine-content {
    padding-left: 72px;
    background: linear-gradient(135deg, #ffcc80 0%, #ffb74d 100%);
    color: #1a3b50;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-9.tree-level-3 .machine-content:hover {
    background: linear-gradient(135deg, #ffb74d 0%, #ffcc80 100%);
  }
  .machine-color-9.tree-level-4 .machine-content {
    padding-left: 88px;
    background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
    color: #1a3b50;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .machine-color-9.tree-level-4 .machine-content:hover {
    background: linear-gradient(135deg, #ffcc80 0%, #ffe0b2 100%);
  }
  
  /* Styles communs pour tous les niveaux avec couleurs */
  [class*="machine-color-"].tree-level-0 .machine-name,
  [class*="machine-color-"].tree-level-1 .machine-name,
  [class*="machine-color-"].tree-level-2 .machine-name,
  [class*="machine-color-"].tree-level-3 .machine-name,
  [class*="machine-color-"].tree-level-4 .machine-name {
    color: white;
    font-weight: 600;
  }
  
  [class*="machine-color-"].tree-level-2.machine-color-2 .machine-name,
  [class*="machine-color-"].tree-level-3.machine-color-2 .machine-name,
  [class*="machine-color-"].tree-level-4.machine-color-2 .machine-name,
  [class*="machine-color-"].tree-level-3.machine-color-9 .machine-name,
  [class*="machine-color-"].tree-level-4.machine-color-9 .machine-name {
    color: #1a3b50;
  }
  
  [class*="machine-color-"].tree-level-0 .machine-code,
  [class*="machine-color-"].tree-level-1 .machine-code,
  [class*="machine-color-"].tree-level-2 .machine-code,
  [class*="machine-color-"].tree-level-3 .machine-code,
  [class*="machine-color-"].tree-level-4 .machine-code {
    color: rgba(255, 255, 255, 0.9);
  }
  
  [class*="machine-color-"].tree-level-2.machine-color-2 .machine-code,
  [class*="machine-color-"].tree-level-3.machine-color-2 .machine-code,
  [class*="machine-color-"].tree-level-4.machine-color-2 .machine-code,
  [class*="machine-color-"].tree-level-3.machine-color-9 .machine-code,
  [class*="machine-color-"].tree-level-4.machine-color-9 .machine-code {
    color: rgba(26, 59, 80, 0.7);
  }
  
  [class*="machine-color-"].tree-level-0 .badge-counter,
  [class*="machine-color-"].tree-level-1 .badge-counter,
  [class*="machine-color-"].tree-level-2 .badge-counter,
  [class*="machine-color-"].tree-level-3 .badge-counter,
  [class*="machine-color-"].tree-level-4 .badge-counter {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
  }
  
  [class*="machine-color-"] .btn-counter-badge {
    background-color: rgba(255, 255, 255, 0.15);
    color: white;
    border-color: rgba(255, 255, 255, 0.3);
  }
  
  [class*="machine-color-"] .btn-counter-badge:hover {
    background-color: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
  }
  
  [class*="machine-color-"].tree-level-0 .btn-action,
  [class*="machine-color-"].tree-level-1 .btn-action,
  [class*="machine-color-"].tree-level-2 .btn-action,
  [class*="machine-color-"].tree-level-3 .btn-action,
  [class*="machine-color-"].tree-level-4 .btn-action {
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
    background: rgba(255, 255, 255, 0.1);
  }
  
  [class*="machine-color-"].tree-level-0 .btn-action:hover,
  [class*="machine-color-"].tree-level-1 .btn-action:hover,
  [class*="machine-color-"].tree-level-2 .btn-action:hover,
  [class*="machine-color-"].tree-level-3 .btn-action:hover,
  [class*="machine-color-"].tree-level-4 .btn-action:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-color: rgba(255, 255, 255, 0.5);
  }
  
  [class*="machine-color-"] .btn-action img,
  [class*="machine-color-"] .btn-action:hover img {
    filter: brightness(0) invert(1);
  }
  
  [class*="machine-color-"].tree-level-0 .machine-status,
  [class*="machine-color-"].tree-level-1 .machine-status,
  [class*="machine-color-"].tree-level-2 .machine-status,
  [class*="machine-color-"].tree-level-3 .machine-status,
  [class*="machine-color-"].tree-level-4 .machine-status {
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
  }
  
  /* Réduction des indentations en mode portable */
  @media (max-width: 768px) {
    .tree-level-1 .machine-content {
      padding-left: 20px;
    }
    
    .tree-level-2 .machine-content {
      padding-left: 28px;
    }
    
    .tree-level-3 .machine-content {
      padding-left: 36px;
    }
    
    .tree-level-4 .machine-content {
      padding-left: 44px;
    }
    
    .machine-children {
      margin-left: 12px;
    }
    
    .machine-content {
      padding: 10px 12px;
      min-height: 48px;
    }
    
    .machine-toggle {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      font-size: 12px;
    }
    
    .machine-info {
      font-size: 0.9rem;
    }
    
    .machine-name {
      font-size: 0.9rem;
    }
    
    .badge-counter {
      font-size: 0.75rem;
      padding: 2px 6px;
    }
    
    .btn-action {
      width: 28px;
      height: 28px;
      font-size: 14px;
      padding: 0;
    }
    
    .machine-actions {
      gap: 4px;
      margin-left: 8px;
    }
  }
  
  .toggle-all-btn {
    background: transparent;
    border: none;
    color: #1a3b50;
    cursor: pointer;
    padding: 8px;
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
  }
  
  .toggle-all-btn:hover {
    background-color: rgba(26, 59, 80, 0.1);
    color: #03192f;
  }
  
  .toggle-all-btn svg,
  .toggle-all-btn img {
    width: 30px;
    height: 30px;
  }
  
  .page-header {
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  
  .actions-row {
    margin-top: 0.5rem !important;
  }
  
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  
  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .actions-row {
    margin-top: 0.5rem;
  }
  
  .add-machine-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #ffc107;
    color: #1a3b50;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    flex-shrink: 0;
  }
  
  .add-machine-btn:hover {
    background-color: #ffb300;
    transform: scale(1.05);
    color: #1a3b50;
    text-decoration: none;
  }
  
  .add-machine-btn:active {
    transform: scale(0.95);
  }
  
  .left-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .maintenance-retard-btn,
  .counter-btn {
    background: transparent;
    border: none;
    color: #1a3b50;
    cursor: pointer;
    padding: 8px;
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .maintenance-retard-btn:hover,
  .counter-btn:hover {
    background-color: rgba(26, 59, 80, 0.1);
    color: #03192f;
  }
  
  .maintenance-retard-btn svg,
  .maintenance-retard-btn img,
  .counter-btn svg,
  .counter-btn img {
    width: 36px;
    height: 36px;
  }
  
  .maintenance-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    border: 2px solid white;
  }
  
  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  /* Styles responsive pour la barre d'actions */
  @media (max-width: 768px) {
    .page-header {
      margin-top: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .page-title {
      font-size: 1.5rem;
    }
    
    .actions-row {
      flex-direction: row;
      align-items: center !important;
      gap: 0.5rem;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    
    .left-actions {
      flex-shrink: 0;
      gap: 0.5rem;
    }
    
    .header-actions {
      gap: 6px;
      flex-shrink: 0;
      justify-content: flex-end;
    }
    
    .add-machine-btn {
      width: 32px;
      height: 32px;
      font-size: 18px;
    }
    
    .toggle-all-btn {
      width: 32px;
      height: 32px;
    }
    
    .toggle-all-btn svg,
    .toggle-all-btn img {
      width: 24px;
      height: 24px;
    }
    
    .maintenance-retard-btn,
    .counter-btn {
      width: 32px;
      height: 32px;
      padding: 6px;
    }
    
    .maintenance-retard-btn svg,
    .maintenance-retard-btn img,
    .counter-btn svg,
    .counter-btn img {
      width: 30px;
      height: 30px;
    }
    
    .maintenance-badge {
      width: 18px;
      height: 18px;
      font-size: 10px;
      top: -2px;
      right: -2px;
    }
  }
</style>

{% if followed_machines_data %}
<div class="mb-4">
  <div class="page-header">
    <h1 class="page-title">{{ t('Les machines suivies') }}</h1>
  </div>
  
  <div class="d-flex justify-content-between align-items-center mb-3 actions-row">
    <div class="left-actions">
      <a href="{{ url_for('maintenance_manage') }}" class="maintenance-retard-btn" title="{{ t('Gestion des maintenances') }}">
        <img src="{{ url_for('static', filename='icons/maintenance-retard.svg') }}" alt="{{ t('Maintenances en retard') }}" style="width: 36px; height: 36px;">
        {% if followed_overdue_count > 0 %}
        <span class="maintenance-badge">{{ followed_overdue_count }}</span>
        {% endif %}
      </a>
      <a href="{{ url_for('counter_report') }}" class="counter-btn" title="{{ t('Relevé compteurs') }}">
        <img src="{{ url_for('static', filename='icons/counter.svg') }}" alt="{{ t('Relevé compteurs') }}" style="width: 36px; height: 36px;">
      </a>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('new_machine') }}" class="add-machine-btn" title="{{ t('Ajouter une machine') }}">
        +
      </a>
      <button type="button" class="toggle-all-btn" id="toggle-all-machines" onclick="toggleAllMachines()" title="{{ t('Afficher toutes les machines') }}">
        <img src="{{ url_for('static', filename='icons/eye.svg') }}" alt="{{ t('Afficher toutes les machines') }}" id="eye-icon" style="width: 30px; height: 30px;">
      </button>
    </div>
  </div>
  
  {% for group in followed_machines_data %}
    {% set root = group.root_machine %}
    {% set root_has_children = root.children|length > 0 %}
    {% set root_is_followed = root.id in followed_machine_ids %}
    {% set has_followed_in_tree = group.has_followed %}
    {% set color_index = group.color_index %}
    
    <div class="machine-tree mb-4" data-tree-id="{{ root.id }}">
      <div class="machine-node tree-level-0 machine-color-{{ color_index }} {% if not root_is_followed %}machine-not-followed{% endif %}" data-machine-id="{{ root.id }}" {% if not root_is_followed and not has_followed_in_tree %}style="display: none;"{% endif %}>
        <div class="machine-content">
          <button 
            type="button" 
            class="machine-toggle {% if not root_has_children %}no-children{% endif %}" 
            data-target="{{ root.id }}"
            data-machine-id="{{ root.id }}">
            {% if root_has_children %}+{% endif %}
          </button>
          
          {% set status = machine_status.get(root.id) %}
          <span class="machine-status {% if status == 'danger' %}danger{% elif status == 'warning' %}warning{% endif %}"></span>
          
          <div class="machine-info">
            <a href="{{ url_for('machine_detail', machine_id=root.id) }}" class="machine-name">
              {{ root.name }} <span class="machine-code">({{ root.code }})</span>
            </a>
            {% if (root.is_root() and root.counters) or root.hour_counter_enabled %}
            <div class="machine-counters-info" style="position: relative; display: inline-block; margin-left: 8px;">
              {% set counters_count = root.counters|length if root.is_root() and root.counters else 1 %}
              <button type="button" class="btn-counter-badge" data-machine-id="{{ root.id }}" title="{{ t('Voir les compteurs') }}">
                {{ counters_count }} {% if counters_count > 1 %}{{ t('compteurs') }}{% else %}{{ t('compteur') }}{% endif %}
              </button>
              <div class="counter-tooltip" id="counter-tooltip-{{ root.id }}" style="display: none;">
                <div class="counter-tooltip-content">
                  {% if root.is_root() and root.counters %}
                    {% for counter in root.counters %}
                    <div class="counter-tooltip-item">
                      <span class="counter-name">{{ counter.name }}:</span>
                      <span class="counter-value">{{ "%.1f"|format(counter.value) }} {{ counter.unit or 'h' }}</span>
                    </div>
                    {% endfor %}
                  {% elif root.hour_counter_enabled %}
                  <div class="counter-tooltip-item">
                    <span class="counter-name">{{ t('Compteur machine') }}:</span>
                    <span class="counter-value">{{ "%.1f"|format(root.hours) }} {{ root.counter_unit or 'h' }}</span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          
          <div class="machine-actions">
            <button 
              type="button" 
              class="btn-action follow-btn {% if root.id in followed_machine_ids %}followed{% endif %}" 
              data-machine-id="{{ root.id }}"
              title="{% if root.id in followed_machine_ids %}Ne plus suivre{% else %}Suivre cette machine{% endif %}">
              {% if root.id in followed_machine_ids %}
                <img src="{{ url_for('static', filename='icons/star.svg') }}" alt="Suivi" style="width: 16px; height: 16px; display: inline-block;">
              {% else %}
                <img src="{{ url_for('static', filename='icons/star-outline.svg') }}" alt="Non suivi" style="width: 16px; height: 16px; display: inline-block;">
              {% endif %}
            </button>
            {% if current_user.user_type in ['admin', 'technicien'] and has_counter_in_tree(root) %}
            <a href="{{ url_for('counter_report', machine_id=root.id) }}" class="btn-action" title="{{ t('Relevé compteurs') }}">
              <img src="{{ url_for('static', filename='icons/counter.svg') }}" alt="Relevé" style="width: 16px; height: 16px;">
            </a>
            {% endif %}
          </div>
        </div>
        
        {% if root_has_children %}
        <div class="machine-children collapsed" id="children-{{ root.id }}">
          {% for child in root.children|sort(attribute='code') %}
            {{ render_machine_node(child, child.depth(), color_index) }}
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>
{% else %}
<div class="mb-4">
  <div class="page-header">
    <h1 class="page-title">{{ t('Les machines suivies') }}</h1>
  </div>
  
  <div class="d-flex justify-content-between align-items-center mb-3 actions-row">
    <div class="left-actions">
      <a href="{{ url_for('maintenance_manage') }}" class="maintenance-retard-btn" title="{{ t('Gestion des maintenances') }}">
        <img src="{{ url_for('static', filename='icons/maintenance-retard.svg') }}" alt="{{ t('Maintenances en retard') }}" style="width: 36px; height: 36px;">
        {% if followed_overdue_count > 0 %}
        <span class="maintenance-badge">{{ followed_overdue_count }}</span>
        {% endif %}
      </a>
      <a href="{{ url_for('counter_report') }}" class="counter-btn" title="{{ t('Relevé compteurs') }}">
        <img src="{{ url_for('static', filename='icons/counter.svg') }}" alt="{{ t('Relevé compteurs') }}" style="width: 36px; height: 36px;">
      </a>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('new_machine') }}" class="add-machine-btn" title="{{ t('Ajouter une machine') }}">
        +
      </a>
    </div>
  </div>
  
  <p class="text-muted">{{ t('Aucune machine suivie. Utilisez l\'étoile sur la page Machines pour suivre vos machines favorites.') }}</p>
</div>
{% endif %}

<!-- Tableau de bord -->
<div class="dashboard-section mt-5 mb-4">
  <div class="page-header">
    <h1 class="page-title">{{ t('Tableau de bord') }}</h1>
  </div>
  
  <div class="dashboard-card card">
    <div class="card-body">
      <!-- Contrôles condensés -->
      <div class="dashboard-controls-compact">
        <div class="row g-3 mb-3">
          <div class="col-md-2">
            <label class="form-label">{{ t('Vue') }}</label>
            <select class="form-select" id="dashboard-view">
              <option value="table">{{ t('Tableau') }}</option>
              <option value="chart">{{ t('Graphique') }}</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ t('Date de début') }}</label>
            <input type="date" class="form-control" id="dashboard-date-start">
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ t('Date de fin') }}</label>
            <input type="date" class="form-control" id="dashboard-date-end">
          </div>
          <div class="col-md-3">
            <label class="form-label">{{ t('Machines') }}</label>
            <select class="form-select" id="dashboard-machines" multiple size="3">
              {% for root in followed_machines_data %}
                {% for node, level in build_machine_tree(root.root_machine) %}
                  {% if node.id in followed_machine_ids %}
                  <option value="{{ node.id }}">
                    {{ '&nbsp;&nbsp;'|safe * level }}{{ node.name }} ({{ node.code }})
                  </option>
                  {% endif %}
                {% endfor %}
              {% endfor %}
            </select>
            <small class="form-text text-muted">{{ t('Ctrl/Cmd pour sélectionner plusieurs') }}</small>
          </div>
          <div class="col-md-3">
            <label class="form-label">{{ t('Métriques') }}</label>
            <select class="form-select" id="dashboard-metrics" multiple size="7">
              <option value="maintenances_preventives">{{ t('Maintenances préventives') }}</option>
              <option value="maintenances_curatives">{{ t('Maintenances curatives') }}</option>
              <option value="cout_produits">{{ t('Coût des produits') }}</option>
              <option value="checklists">{{ t('Checklists') }}</option>
              <option value="maintenances_retard">{{ t('Maintenances en retard') }}</option>
              <option value="maintenances_a_heure">{{ t('Maintenances à l\'heure') }}</option>
              <option value="mises_a_jour_compteur">{{ t('Mises à jour compteur') }}</option>
            </select>
            <small class="form-text text-muted">{{ t('Ctrl/Cmd pour sélectionner plusieurs') }}</small>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <button type="button" class="btn btn-primary-fms" id="dashboard-update">{{ t('Actualiser') }}</button>
          </div>
        </div>
      </div>
      
      <!-- Zone de résultats (tableau ou graphique) -->
      <div class="dashboard-content mt-4">
        <div id="dashboard-loading" class="text-center" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
        </div>
        
        <!-- Conteneur pour le tableau -->
        <div id="dashboard-table-container" style="display: none;"></div>
        
        <!-- Conteneur pour le graphique -->
        <div id="dashboard-chart-container" style="display: none;">
          <canvas id="dashboard-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.dashboard-section {
  margin-top: 3rem;
}

.dashboard-card {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.dashboard-controls-compact .form-select[multiple] {
  min-height: 80px;
  font-size: 0.875rem;
}

.dashboard-controls-compact .form-select[multiple]#dashboard-metrics {
  min-height: 120px;
}

.dashboard-content {
  min-height: 300px;
}

#dashboard-table-container table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

#dashboard-table-container th,
#dashboard-table-container td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}

#dashboard-table-container th {
  background-color: #1a3b50;
  color: white;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
}

#dashboard-table-container tr:hover {
  background-color: #f8f9fa;
}

#dashboard-table-container .metric-value {
  font-weight: 600;
  color: #1a3b50;
}

#dashboard-table-container .metric-cost {
  color: #28a745;
}

#dashboard-chart-container {
  min-height: 400px;
  padding: 1rem 0;
}

#dashboard-chart-container canvas {
  max-height: 500px;
}

@media (max-width: 768px) {
  .dashboard-controls-compact .row > div {
    margin-bottom: 1rem;
  }
  
  #dashboard-table-container {
    overflow-x: auto;
  }
  
  #dashboard-table-container table {
    font-size: 0.875rem;
  }
  
  #dashboard-table-container th,
  #dashboard-table-container td {
    padding: 0.5rem;
  }
}
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let showAllMachines = false;
let dashboardChart = null;

function toggleAllMachines() {
  showAllMachines = !showAllMachines;
  const button = document.getElementById('toggle-all-machines');
  
  console.log('=== TOGGLE ALL MACHINES ===');
  console.log('showAllMachines:', showAllMachines);
  
  if (showAllMachines) {
    // ÉTAPE 1: Déplier TOUS les enfants d'abord (même ceux dans des divs collapsed)
    const allChildren = document.querySelectorAll('.machine-children');
    console.log('Tous les enfants trouvés:', allChildren.length);
    
    allChildren.forEach(childrenDiv => {
      // Forcer l'affichage en enlevant collapsed et en ajoutant expanded
      childrenDiv.classList.remove('collapsed');
      childrenDiv.classList.add('expanded');
      childrenDiv.style.display = 'block';
      
      // Afficher aussi le parent si nécessaire
      const parentNode = childrenDiv.closest('.machine-node');
      if (parentNode) {
        parentNode.style.display = '';
        const toggleBtn = parentNode.querySelector('.machine-toggle:not(.no-children)');
        if (toggleBtn) {
          toggleBtn.textContent = '−';
        }
      }
    });
    
    // ÉTAPE 2: Afficher toutes les machines non suivies
    const allNotFollowed = document.querySelectorAll('.machine-not-followed');
    console.log('Machines non suivies trouvées:', allNotFollowed.length);
    
    allNotFollowed.forEach(node => {
      node.style.display = '';
      // S'assurer que tous les parents sont aussi affichés
      let current = node;
      while (current && current !== document.body) {
        if (current.classList && current.classList.contains('machine-node')) {
          current.style.display = '';
        }
        if (current.classList && current.classList.contains('machine-children')) {
          current.classList.remove('collapsed');
          current.classList.add('expanded');
          current.style.display = 'block';
        }
        current = current.parentElement;
      }
    });
    
    const eyeIcon = button.querySelector('#eye-icon');
    if (eyeIcon) {
      eyeIcon.src = "{{ url_for('static', filename='icons/eye-slash.svg') }}";
    }
    button.title = '{{ t('Masquer les machines non suivies') }}';
  } else {
    // Masquer toutes les machines non suivies
    const allNotFollowed = document.querySelectorAll('.machine-not-followed');
    allNotFollowed.forEach(node => {
      node.style.display = 'none';
    });
    
    // Replier seulement ceux qui ne sont pas suivis
    const allChildren = document.querySelectorAll('.machine-children');
    allChildren.forEach(childrenDiv => {
      const parentNode = childrenDiv.closest('.machine-node');
      if (parentNode && parentNode.classList.contains('machine-not-followed')) {
        childrenDiv.classList.remove('expanded');
        childrenDiv.classList.add('collapsed');
        const toggleBtn = parentNode.querySelector('.machine-toggle:not(.no-children)');
        if (toggleBtn) {
          toggleBtn.textContent = '+';
        }
      }
    });
    
    const eyeIcon = button.querySelector('#eye-icon');
    if (eyeIcon) {
      eyeIcon.src = "{{ url_for('static', filename='icons/eye.svg') }}";
    }
    button.title = '{{ t('Afficher toutes les machines') }}';
  }
  
  console.log('=== FIN TOGGLE ===');
}

function toggleMachine(button, machineId) {
  const childrenDiv = document.getElementById('children-' + machineId);
  if (!childrenDiv) return;
  
  const isCollapsed = childrenDiv.classList.contains('collapsed');
  
  if (isCollapsed) {
    childrenDiv.classList.remove('collapsed');
    childrenDiv.classList.add('expanded');
    button.textContent = '−';
    // Sauvegarder l'état dans localStorage
    localStorage.setItem('machine-' + machineId + '-expanded', 'true');
  } else {
    childrenDiv.classList.remove('expanded');
    childrenDiv.classList.add('collapsed');
    button.textContent = '+';
    // Sauvegarder l'état dans localStorage
    localStorage.setItem('machine-' + machineId + '-expanded', 'false');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Debug: vérifier combien de machines sont dans le HTML
  const allMachines = document.querySelectorAll('.machine-node');
  const allNotFollowedMachines = document.querySelectorAll('.machine-not-followed');
  console.log('=== DEBUG PAGE ACCUEIL ===');
  console.log('Total machines dans le HTML:', allMachines.length);
  console.log('Machines non suivies dans le HTML:', allNotFollowedMachines.length);
  console.log('=======================');
  
  // Restaurer l'état de dépliage/repliage depuis localStorage
  function restoreMachineStates() {
    document.querySelectorAll('.machine-children').forEach(childrenDiv => {
      const machineId = childrenDiv.id.replace('children-', '');
      const savedState = localStorage.getItem('machine-' + machineId + '-expanded');
      
      if (savedState === 'true') {
        childrenDiv.classList.remove('collapsed');
        childrenDiv.classList.add('expanded');
        const button = document.querySelector('.machine-toggle[data-target="' + machineId + '"], .machine-toggle[data-machine-id="' + machineId + '"]');
        if (button && !button.classList.contains('no-children')) {
          button.textContent = '−';
        }
      } else if (savedState === 'false') {
        childrenDiv.classList.remove('expanded');
        childrenDiv.classList.add('collapsed');
        const button = document.querySelector('.machine-toggle[data-target="' + machineId + '"], .machine-toggle[data-machine-id="' + machineId + '"]');
        if (button && !button.classList.contains('no-children')) {
          button.textContent = '+';
        }
      }
      // Si pas d'état sauvegardé, on garde l'état initial du HTML
    });
  }
  
  // Restaurer les états avant d'attacher les listeners
  restoreMachineStates();
  
  // Attacher les listeners aux boutons toggle
  function attachToggleListeners() {
    document.querySelectorAll('.machine-toggle:not(.no-children)').forEach(button => {
      if (!button.dataset.listenerAttached) {
        button.dataset.listenerAttached = 'true';
        const machineId = button.getAttribute('data-target') || button.getAttribute('data-machine-id');
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleMachine(this, machineId);
        });
      }
    });
  }
  
  attachToggleListeners();
  
  // Initialiser les boutons de suivi
  const followButtons = document.querySelectorAll('.follow-btn');
  
  followButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      const machineId = this.getAttribute('data-machine-id');
      
      this.disabled = true;
      
      fetch(`/machines/${machineId}/toggle-follow`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (data.is_followed) {
            this.innerHTML = '<img src="/static/icons/star.svg" alt="Suivi" style="width: 16px; height: 16px; display: inline-block;">';
            this.classList.add('followed');
            this.title = 'Ne plus suivre';
          } else {
            this.innerHTML = '<img src="/static/icons/star-outline.svg" alt="Non suivi" style="width: 16px; height: 16px; display: inline-block;">';
            this.classList.remove('followed');
            this.title = 'Suivre cette machine';
          }
          // Recharger la page pour mettre à jour l'affichage
          location.reload();
        } else {
          alert('Erreur : ' + (data.error || 'Impossible de modifier le suivi'));
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la modification du suivi');
      })
      .finally(() => {
        this.disabled = false;
      });
    });
  });
});

// Tableau de bord
document.addEventListener('DOMContentLoaded', function() {
  // Traductions pour le JavaScript
  const translations = {
    'Veuillez sélectionner au moins une machine.': '{{ t('Veuillez sélectionner au moins une machine.') }}',
    'Veuillez sélectionner au moins une métrique.': '{{ t('Veuillez sélectionner au moins une métrique.') }}',
    'Aucune donnée disponible pour les critères sélectionnés.': '{{ t('Aucune donnée disponible pour les critères sélectionnés.') }}',
    'Erreur lors du chargement des données :': '{{ t('Erreur lors du chargement des données :') }}',
    'Machine': '{{ t('Machine') }}',
    'Maintenances préventives': '{{ t('Maintenances préventives') }}',
    'Maintenances curatives': '{{ t('Maintenances curatives') }}',
    'Coût produits (€)': '{{ t('Coût produits (€)') }}',
    'Checklists': '{{ t('Checklists') }}',
    'En retard': '{{ t('En retard') }}',
    'À l\'heure': '{{ t('À l\'heure') }}',
    'Mises à jour compteur': '{{ t('Mises à jour compteur') }}',
    'Coût': '{{ t('Coût des produits') }}'
  };
  
  const updateBtn = document.getElementById('dashboard-update');
  const viewSelect = document.getElementById('dashboard-view');
  const dateStartInput = document.getElementById('dashboard-date-start');
  const dateEndInput = document.getElementById('dashboard-date-end');
  const machinesSelect = document.getElementById('dashboard-machines');
  const metricsSelect = document.getElementById('dashboard-metrics');
  const loadingDiv = document.getElementById('dashboard-loading');
  const tableContainer = document.getElementById('dashboard-table-container');
  const chartContainer = document.getElementById('dashboard-chart-container');
  const chartCanvas = document.getElementById('dashboard-chart');
  
  // Initialiser les dates par défaut (depuis le début jusqu'à aujourd'hui)
  const today = new Date().toISOString().split('T')[0];
  dateEndInput.value = today;
  // Laisser date de début vide pour "depuis le début"
  
  // Gérer le changement de vue
  viewSelect.addEventListener('change', function() {
    const view = this.value;
    if (view === 'table') {
      tableContainer.style.display = 'block';
      chartContainer.style.display = 'none';
    } else {
      tableContainer.style.display = 'none';
      chartContainer.style.display = 'block';
    }
  });
  
  // Initialiser l'affichage selon la vue par défaut
  if (viewSelect.value === 'table') {
    tableContainer.style.display = 'block';
    chartContainer.style.display = 'none';
  } else {
    tableContainer.style.display = 'none';
    chartContainer.style.display = 'block';
  }
  
  function updateDashboard() {
    // Récupérer les machines sélectionnées
    const selectedMachines = Array.from(machinesSelect.selectedOptions).map(opt => opt.value);
    if (selectedMachines.length === 0) {
      tableContainer.innerHTML = '<p class="text-muted">' + translations['Veuillez sélectionner au moins une machine.'] + '</p>';
      return;
    }
    
    // Récupérer les métriques sélectionnées
    const selectedMetrics = Array.from(metricsSelect.selectedOptions).map(opt => opt.value);
    
    if (selectedMetrics.length === 0) {
      tableContainer.innerHTML = '<p class="text-muted">' + translations['Veuillez sélectionner au moins une métrique.'] + '</p>';
      return;
    }
    
    // Récupérer les dates
    const dateStart = dateStartInput.value || '';
    const dateEnd = dateEndInput.value || '';
    
    // Afficher le chargement
    loadingDiv.style.display = 'block';
    tableContainer.innerHTML = '';
    chartContainer.innerHTML = '<canvas id="dashboard-chart"></canvas>';
    const currentChartCanvas = document.getElementById('dashboard-chart');
    
    const metricLabels = {
      'maintenances_preventives': translations['Maintenances préventives'],
      'maintenances_curatives': translations['Maintenances curatives'],
      'cout_produits': translations['Coût produits (€)'],
      'checklists': translations['Checklists'],
      'maintenances_retard': translations['En retard'],
      'maintenances_a_heure': translations['À l\'heure'],
      'mises_a_jour_compteur': translations['Mises à jour compteur']
    };
    
    const currentView = viewSelect.value;
    const machineIds = selectedMachines.join(',');
    const metrics = selectedMetrics.join(',');
    
    if (currentView === 'table') {
      // Afficher le tableau
      const url = `/api/dashboard?date_start=${encodeURIComponent(dateStart)}&date_end=${encodeURIComponent(dateEnd)}&machine_ids=${encodeURIComponent(machineIds)}&metrics=${encodeURIComponent(metrics)}`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          loadingDiv.style.display = 'none';
          
          if (!data.success || !data.data || data.data.length === 0) {
            tableContainer.innerHTML = '<p class="text-muted">' + translations['Aucune donnée disponible pour les critères sélectionnés.'] + '</p>';
            return;
          }
          
          // Créer le tableau
          const table = document.createElement('table');
          table.className = 'table table-striped';
          
          // En-têtes
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          const machineHeader = document.createElement('th');
          machineHeader.textContent = translations['Machine'];
          headerRow.appendChild(machineHeader);
          
          selectedMetrics.forEach(metric => {
            const th = document.createElement('th');
            th.textContent = metricLabels[metric] || metric;
            headerRow.appendChild(th);
          });
          
          thead.appendChild(headerRow);
          table.appendChild(thead);
          
          // Corps du tableau
          const tbody = document.createElement('tbody');
          data.data.forEach(machineData => {
            const row = document.createElement('tr');
            
            // Nom de la machine
            const machineCell = document.createElement('td');
            machineCell.innerHTML = `<strong>${machineData.machine_name}</strong><br><small class="text-muted">${machineData.machine_code}</small>`;
            row.appendChild(machineCell);
            
            // Valeurs des métriques
            selectedMetrics.forEach(metric => {
              const cell = document.createElement('td');
              const value = machineData.metrics[metric];
              if (value !== undefined) {
                if (metric === 'cout_produits') {
                  cell.className = 'metric-value metric-cost';
                  cell.textContent = value.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
                } else {
                  cell.className = 'metric-value';
                  cell.textContent = value;
                }
              } else {
                cell.textContent = '-';
              }
              row.appendChild(cell);
            });
            
            tbody.appendChild(row);
          });
          
          table.appendChild(tbody);
          tableContainer.innerHTML = '';
          tableContainer.appendChild(table);
        })
        .catch(error => {
          loadingDiv.style.display = 'none';
          tableContainer.innerHTML = '<p class="text-danger">' + translations['Erreur lors du chargement des données :'] + ' ' + error.message + '</p>';
          console.error('Erreur:', error);
        });
    } else {
      // Afficher le graphique
      updateChart(dateStart, dateEnd, selectedMachines, selectedMetrics, metricLabels);
    }
  }
  
  function updateChart(dateStart, dateEnd, selectedMachines, selectedMetrics, metricLabels) {
    // Détruire le graphique existant s'il existe
    if (dashboardChart) {
      dashboardChart.destroy();
      dashboardChart = null;
    }
    
    if (!selectedMachines || selectedMachines.length === 0 || !selectedMetrics || selectedMetrics.length === 0) {
      chartContainer.innerHTML = '<p class="text-muted text-center">' + translations['Aucune donnée disponible pour les critères sélectionnés.'] + '</p>';
      return;
    }
    
    // Construire l'URL de l'API pour le graphique temporel
    const machineIds = selectedMachines.join(',');
    const metrics = selectedMetrics.join(',');
    const url = `/api/dashboard-chart?date_start=${encodeURIComponent(dateStart || '')}&date_end=${encodeURIComponent(dateEnd || '')}&machine_ids=${encodeURIComponent(machineIds)}&metrics=${encodeURIComponent(metrics)}`;
    
    // Appel API pour les données temporelles
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        loadingDiv.style.display = 'none';
        console.log('Chart data received:', data);
        
        if (!data || !data.success || !data.data || data.data.length === 0) {
          console.log('No chart data available:', data);
          chartContainer.innerHTML = '<p class="text-muted text-center">' + translations['Aucune donnée disponible pour les critères sélectionnés.'] + '</p>';
          return;
        }
        
        // Préparer les données pour le graphique temporel
        const labels = data.data.map(d => d.period_label);
        const datasets = [];
        
        // Couleurs pour les différentes métriques
        const colors = [
          { border: 'rgb(26, 59, 80)', background: 'rgba(26, 59, 80, 0.1)' },
          { border: 'rgb(40, 167, 69)', background: 'rgba(40, 167, 69, 0.1)' },
          { border: 'rgb(220, 53, 69)', background: 'rgba(220, 53, 69, 0.1)' },
          { border: 'rgb(255, 193, 7)', background: 'rgba(255, 193, 7, 0.1)' },
          { border: 'rgb(23, 162, 184)', background: 'rgba(23, 162, 184, 0.1)' },
          { border: 'rgb(108, 117, 125)', background: 'rgba(108, 117, 125, 0.1)' },
          { border: 'rgb(111, 66, 193)', background: 'rgba(111, 66, 193, 0.1)' }
        ];
        
        selectedMetrics.forEach((metric, index) => {
          const values = data.data.map(d => {
            if (!d || !d.metrics) {
              console.warn('Invalid data point:', d);
              return 0;
            }
            const value = d.metrics[metric];
            return value !== undefined ? value : 0;
          });
          
          datasets.push({
            label: metricLabels[metric] || metric,
            data: values,
            borderColor: colors[index % colors.length].border,
            backgroundColor: colors[index % colors.length].background,
            tension: 0.4,
            fill: false
          });
        });
        
        // Créer le graphique
        const currentChartCanvas = document.getElementById('dashboard-chart');
        if (!currentChartCanvas) {
          console.error('Chart canvas not found');
          return;
        }
        
        const ctx = currentChartCanvas.getContext('2d');
        if (!ctx) {
          console.error('Could not get 2d context');
          return;
        }
        
        dashboardChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  font: {
                    family: 'Montserrat',
                    size: 12
                  }
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed.y;
                    if (context.dataset.label.includes(translations['Coût']) || context.dataset.label.includes('Coût')) {
                      return label + ': ' + value.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
                    }
                    return label + ': ' + value;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  font: {
                    family: 'Montserrat'
                  }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              },
              x: {
                ticks: {
                  font: {
                    family: 'Montserrat'
                  },
                  maxRotation: 45,
                  minRotation: 45
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            },
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false
            }
          }
        });
      })
      .catch(error => {
        loadingDiv.style.display = 'none';
        console.error('Erreur lors du chargement du graphique:', error);
        chartContainer.innerHTML = '<p class="text-danger text-center">' + translations['Erreur lors du chargement des données :'] + ' ' + error.message + '</p>';
      });
  }
  
  // Événements
  updateBtn.addEventListener('click', updateDashboard);
  
  // Charger les données au chargement de la page
  updateDashboard();
  
  // Gestion des tooltips de compteurs
  const counterBadges = document.querySelectorAll('.btn-counter-badge');
  
  counterBadges.forEach(function(badge) {
    const machineId = badge.getAttribute('data-machine-id');
    const tooltip = document.getElementById('counter-tooltip-' + machineId);
    
    if (!tooltip) return;
    
    // Détecter si on est sur mobile
    const isMobile = window.matchMedia('(max-width: 768px)').matches;
    
    if (isMobile) {
      // Sur mobile : afficher au clic
      let isOpen = false;
      badge.addEventListener('click', function(e) {
        e.stopPropagation();
        if (isOpen) {
          tooltip.style.display = 'none';
          isOpen = false;
        } else {
          // Fermer tous les autres tooltips
          document.querySelectorAll('.counter-tooltip').forEach(function(t) {
            t.style.display = 'none';
          });
          tooltip.style.display = 'block';
          isOpen = true;
        }
      });
      
      // Fermer au clic ailleurs
      document.addEventListener('click', function(e) {
        if (!badge.contains(e.target) && !tooltip.contains(e.target)) {
          tooltip.style.display = 'none';
          isOpen = false;
        }
      });
    } else {
      // Sur desktop : afficher au survol
      badge.addEventListener('mouseenter', function() {
        const rect = badge.getBoundingClientRect();
        tooltip.style.display = 'block';
        tooltip.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
        tooltip.style.transform = 'translateX(-50%)';
      });
      
      badge.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
      });
      
      // Garder le tooltip ouvert si on survole le tooltip lui-même
      tooltip.addEventListener('mouseenter', function() {
        tooltip.style.display = 'block';
      });
      
      tooltip.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
      });
    }
  });
});
</script>
{% endblock %}
