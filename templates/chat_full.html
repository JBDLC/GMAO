{% extends "base.html" %}

{% block title %}{{ t('Chat et Informations') }}{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">{{ t('Chat et Informations') }}</h1>
</div>

<div class="card">
  <div class="card-body p-0">
    <!-- Filtres -->
    <div class="chat-filters p-3 border-bottom">
      <button class="chat-filter-btn active" data-filter="all" id="filter-all">{{ t('Tous') }}</button>
      <button class="chat-filter-btn" data-filter="manual" id="filter-manual">{{ t('Messages') }}</button>
      <button class="chat-filter-btn" data-filter="auto" id="filter-auto">{{ t('Système') }}</button>
      <button class="chat-filter-btn" data-filter="report" id="filter-report">{{ t('Rapport') }}</button>
    </div>
    
    <!-- Messages -->
    <div class="chat-messages" id="chat-messages" style="min-height: 400px; max-height: 600px; overflow-y: auto; padding: 1rem;">
      <!-- Messages will be loaded here -->
    </div>
    
    <!-- Zone de saisie -->
    <div class="chat-input-area p-3 border-top" id="chat-input-area">
      <div id="chat-reply-preview" style="display: none;"></div>
      <form class="chat-input-form d-flex gap-2 align-items-center" id="chat-form">
        <button type="button" class="chat-add-report-btn-input" id="chat-add-report-btn" title="{{ t('Créer un rapport') }}">
          +
        </button>
        <input type="text" class="form-control chat-input" id="chat-input" placeholder="{{ t('Tapez votre message...') }}" required>
        <button type="submit" class="btn btn-primary-fms" id="chat-send-btn">{{ t('Envoyer') }}</button>
      </form>
    </div>
  </div>
</div>

<!-- Modal pour créer/éditer un rapport -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportModalTitle">{{ t('Créer un rapport') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="report-form">
          <input type="hidden" id="report-id" name="report_id">
          <div class="mb-3">
            <label for="report-content" class="form-label">{{ t('Contenu du rapport') }}</label>
            <textarea class="form-control" id="report-content" name="content" rows="6" required placeholder="{{ t('Décrivez votre rapport de poste/jour...') }}"></textarea>
          </div>
          <div class="mb-3">
            <label for="report-photos" class="form-label">{{ t('Photos (optionnel)') }}</label>
            <input type="file" class="form-control" id="report-photos" name="photos" multiple accept="image/*">
            <small class="form-text text-muted">{{ t('Vous pouvez sélectionner plusieurs photos') }}</small>
          </div>
          <div id="report-photos-preview" class="mb-3"></div>
          <div id="report-existing-photos" class="mb-3"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('Annuler') }}</button>
        <button type="button" class="btn btn-primary" id="report-submit-btn">{{ t('Enregistrer') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour afficher une photo en grand -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="photo-modal-img" src="" alt="Photo" style="max-width: 100%; max-height: 80vh;">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Chat translations
  const chatTranslations = {
    'Tapez votre message...': '{{ t("Tapez votre message...") }}',
    'Envoyer': '{{ t("Envoyer") }}',
    'Modifier': '{{ t("Modifier") }}',
    'Modifier le message...': '{{ t("Modifier le message...") }}',
    'Répondre à': '{{ t("Répondre à") }}',
    'Aucun message': '{{ t("Aucun message") }}',
    'Aucun message écrit': '{{ t("Aucun message écrit") }}',
    'Aucun message système': '{{ t("Aucun message système") }}',
    'Aucun rapport': '{{ t("Aucun rapport") }}',
    'Créer un rapport': '{{ t("Créer un rapport") }}',
    'Modifier le rapport': '{{ t("Modifier le rapport") }}',
    'Supprimer': '{{ t("Supprimer") }}',
    'Répondre': '{{ t("Répondre") }}',
    'Êtes-vous sûr de vouloir supprimer ce rapport ?': '{{ t("Êtes-vous sûr de vouloir supprimer ce rapport ?") }}',
    'Êtes-vous sûr de vouloir supprimer ce message ?': '{{ t("Êtes-vous sûr de vouloir supprimer ce message ?") }}',
    'Impossible de modifier le rapport': '{{ t("Impossible de modifier le rapport") }}',
    'Impossible de supprimer le rapport': '{{ t("Impossible de supprimer le rapport") }}',
    'Impossible de supprimer le message': '{{ t("Impossible de supprimer le message") }}',
    'Impossible de modifier le message': '{{ t("Impossible de modifier le message") }}',
    'Impossible d\'envoyer le message': '{{ t("Impossible d\'envoyer le message") }}',
    'Erreur': '{{ t("Erreur") }}'
  };
  
  // Chat functionality
  (function() {
    // Attendre que le DOM soit complètement chargé
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initChat);
    } else {
      // DOM déjà chargé
      initChat();
    }
    
    function initChat() {
      const chatMessages = document.getElementById('chat-messages');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const chatSendBtn = document.getElementById('chat-send-btn');
      
      if (!chatMessages || !chatForm || !chatInput) {
        console.error('Chat elements not found');
        return;
      }
      
      let refreshInterval = null;
      let lastMessageId = 0;
      let currentFilter = 'all';
      let lastMessagesHash = '';
      let replyingTo = null;
      let editingMessageId = null;
      let editingReportId = null;
      const chatReplyPreview = document.getElementById('chat-reply-preview');
      const chatInputArea = document.getElementById('chat-input-area');
      const chatAddReportBtn = document.getElementById('chat-add-report-btn');
      const reportModalEl = document.getElementById('reportModal');
      const photoModalEl = document.getElementById('photoModal');
      let reportModal = null;
      let photoModal = null;
      
      // Initialiser les modales après le chargement de Bootstrap
      if (typeof bootstrap !== 'undefined' && reportModalEl) {
        reportModal = new bootstrap.Modal(reportModalEl);
      }
      if (typeof bootstrap !== 'undefined' && photoModalEl) {
        photoModal = new bootstrap.Modal(photoModalEl);
      }
    
      // Filter buttons
      const filterButtons = document.querySelectorAll('.chat-filter-btn');
      filterButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          filterButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.getAttribute('data-filter');
          loadMessages();
        });
      });
      
      // Add report button
      if (chatAddReportBtn) {
        chatAddReportBtn.addEventListener('click', function() {
          editingReportId = null;
          const reportModalTitle = document.getElementById('reportModalTitle');
          const reportForm = document.getElementById('report-form');
          if (reportModalTitle) reportModalTitle.textContent = chatTranslations['Créer un rapport'];
          if (reportForm) reportForm.reset();
          const reportId = document.getElementById('report-id');
          if (reportId) reportId.value = '';
          const photosPreview = document.getElementById('report-photos-preview');
          if (photosPreview) photosPreview.innerHTML = '';
          const existingPhotos = document.getElementById('report-existing-photos');
          if (existingPhotos) existingPhotos.innerHTML = '';
          if (reportModal) reportModal.show();
        });
      }
      
      // Photo preview
      const reportPhotosInput = document.getElementById('report-photos');
      if (reportPhotosInput) {
        reportPhotosInput.addEventListener('change', function(e) {
          const preview = document.getElementById('report-photos-preview');
          preview.innerHTML = '';
          Array.from(e.target.files).forEach(file => {
            if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '120px';
                img.style.height = '120px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                img.style.marginRight = '8px';
                img.style.marginBottom = '8px';
                preview.appendChild(img);
              };
              reader.readAsDataURL(file);
            }
          });
        });
      }
      
      // Submit report
      const reportSubmitBtn = document.getElementById('report-submit-btn');
      if (reportSubmitBtn) {
        reportSubmitBtn.addEventListener('click', function() {
          const form = document.getElementById('report-form');
          const formData = new FormData(form);
          
          if (editingReportId) {
            formData.append('report_id', editingReportId);
            fetch(`/reports/${editingReportId}`, {
              method: 'PUT',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                if (reportModal) reportModal.hide();
                lastMessagesHash = '';
                loadMessages();
              } else {
                alert(chatTranslations['Erreur'] + ' : ' + (data.error || chatTranslations['Impossible de modifier le rapport']));
              }
            })
            .catch(error => {
              console.error('Erreur:', error);
              alert('Erreur lors de la modification du rapport');
            });
          } else {
            fetch('/reports', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                if (reportModal) reportModal.hide();
                lastMessagesHash = '';
                loadMessages();
              } else {
                alert(chatTranslations['Erreur'] + ' : ' + (data.error || chatTranslations['Impossible de modifier le rapport']));
              }
            })
            .catch(error => {
              console.error('Erreur:', error);
              alert('Erreur lors de la création du rapport');
            });
          }
        });
      }
      
      // Edit report function
      window.editReport = function(reportId) {
      fetch('/reports')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const report = data.reports.find(r => r.id === reportId);
            if (report) {
              editingReportId = report.id;
              const reportModalTitle = document.getElementById('reportModalTitle');
              const reportContent = document.getElementById('report-content');
              const reportIdInput = document.getElementById('report-id');
              const photosPreview = document.getElementById('report-photos-preview');
              const existingPhotosDiv = document.getElementById('report-existing-photos');
              
              if (reportModalTitle) reportModalTitle.textContent = chatTranslations['Modifier le rapport'];
              if (reportContent) reportContent.value = report.content;
              if (reportIdInput) reportIdInput.value = report.id;
              if (photosPreview) photosPreview.innerHTML = '';
              
              if (existingPhotosDiv) {
                existingPhotosDiv.innerHTML = '<label class="form-label">Photos existantes</label>';
                report.photos.forEach(photo => {
                  const photoDiv = document.createElement('div');
                  photoDiv.style.display = 'flex';
                  photoDiv.style.alignItems = 'center';
                  photoDiv.style.gap = '8px';
                  photoDiv.style.marginBottom = '8px';
                  
                  const img = document.createElement('img');
                  img.src = photo.url;
                  img.style.width = '60px';
                  img.style.height = '60px';
                  img.style.objectFit = 'cover';
                  img.style.borderRadius = '4px';
                  
                  const checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.name = 'delete_photos';
                  checkbox.value = photo.id;
                  checkbox.id = `photo-${photo.id}`;
                  
                  const label = document.createElement('label');
                  label.htmlFor = `photo-${photo.id}`;
                  label.textContent = chatTranslations['Supprimer'];
                  label.style.cursor = 'pointer';
                  
                  photoDiv.appendChild(img);
                  photoDiv.appendChild(checkbox);
                  photoDiv.appendChild(label);
                  existingPhotosDiv.appendChild(photoDiv);
                });
              }
              
              if (reportModal) reportModal.show();
            }
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('Erreur lors du chargement du rapport');
        });
    };
    
      // Delete report function
      window.deleteReport = function(reportId) {
        if (confirm(chatTranslations['Êtes-vous sûr de vouloir supprimer ce rapport ?'])) {
          fetch(`/reports/${reportId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              lastMessagesHash = '';
              loadMessages();
            } else {
              alert(chatTranslations['Erreur'] + ' : ' + (data.error || chatTranslations['Impossible de supprimer le rapport']));
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression du rapport');
          });
        }
      };
      
      // Cancel reply
      function cancelReply() {
        replyingTo = null;
        chatReplyPreview.style.display = 'none';
        chatInput.placeholder = chatTranslations['Tapez votre message...'];
      }
      
      // Cancel edit
      function cancelEdit() {
        editingMessageId = null;
        chatInput.value = '';
        chatInput.placeholder = chatTranslations['Tapez votre message...'];
        chatSendBtn.textContent = chatTranslations['Envoyer'];
      }
      
      // Render functions - définies avant loadMessages pour être accessibles
      function renderAllItems(items) {
              const itemsHash = JSON.stringify(items.map(item => ({
                id: item.id || item.report_id,
                type: item.type,
                content: item.content ? item.content.substring(0, 100) : '',
                date: item.date,
                time: item.time,
                edited: item.edited || false,
                photos_count: item.photos ? item.photos.length : 0
              })));
              
              if (itemsHash === lastMessagesHash && chatMessages.children.length === items.length) {
                return;
              }
              
              lastMessagesHash = itemsHash;
              
              const wasAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop < 150;
              const scrollPosition = chatMessages.scrollTop;
              const scrollHeight = chatMessages.scrollHeight;
              
              requestAnimationFrame(() => {
                chatMessages.innerHTML = '';
                
                if (items.length === 0) {
                  const emptyDiv = document.createElement('div');
                  emptyDiv.className = 'chat-message';
                  emptyDiv.style.textAlign = 'center';
                  emptyDiv.style.color = '#6c757d';
                  emptyDiv.textContent = currentFilter === 'all' 
                    ? chatTranslations['Aucun message'] 
                    : currentFilter === 'manual' 
                      ? chatTranslations['Aucun message écrit'] 
                      : currentFilter === 'auto'
                        ? chatTranslations['Aucun message système']
                        : chatTranslations['Aucun rapport'];
                  chatMessages.appendChild(emptyDiv);
                } else {
                  items.forEach(item => {
                    if (item.type === 'report') {
                      renderReportMessage(item);
                    } else {
                      renderChatMessage(item);
                    }
                  });
                }
                
                requestAnimationFrame(() => {
                  if (wasAtBottom || chatMessages.scrollTop === 0) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                  } else {
                    const newScrollHeight = chatMessages.scrollHeight;
                    const heightDiff = newScrollHeight - scrollHeight;
                    chatMessages.scrollTop = scrollPosition + heightDiff;
                  }
                });
              });
            }
            
            function renderChatMessage(msg) {
              const messageDiv = document.createElement('div');
              messageDiv.className = `chat-message ${msg.type} ${msg.is_own ? 'own' : ''}`;
              messageDiv.setAttribute('data-message-id', msg.id);
              
              if (msg.reply_to) {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'chat-message-reply';
                replyDiv.innerHTML = `
                  <div class="chat-message-reply-user">${msg.reply_to.user_name}</div>
                  <div class="chat-message-reply-content">${msg.reply_to.content}</div>
                `;
                replyDiv.addEventListener('click', function() {
                  const originalMsg = chatMessages.querySelector(`[data-message-id="${msg.reply_to.id}"]`);
                  if (originalMsg) {
                    originalMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    originalMsg.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                      originalMsg.style.backgroundColor = '';
                    }, 2000);
                  }
                });
                messageDiv.appendChild(replyDiv);
              }
              
              const header = document.createElement('div');
              header.className = 'chat-message-header';
              
              const userSpan = document.createElement('span');
              userSpan.className = 'chat-message-user';
              userSpan.textContent = msg.user_name || 'Système';
              
              const headerRight = document.createElement('div');
              headerRight.className = 'chat-message-header-right';
              
              if (msg.type === 'manual') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'chat-message-actions';
                
                if (msg.is_own) {
                  actionsDiv.innerHTML = `
                    <button class="chat-message-action-btn" onclick="replyToMessage(${msg.id})" title="${chatTranslations['Répondre']}">↩</button>
                    <button class="chat-message-action-btn" onclick="editMessage(${msg.id}, '${msg.content.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" title="${chatTranslations['Modifier']}"><img src="/static/icons/edit.svg" alt="${chatTranslations['Modifier']}" style="width: 14px; height: 14px;"></button>
                    <button class="chat-message-action-btn" onclick="deleteMessage(${msg.id})" title="${chatTranslations['Supprimer']}"><img src="/static/icons/delete.svg" alt="${chatTranslations['Supprimer']}" style="width: 14px; height: 14px;"></button>
                  `;
                } else {
                  actionsDiv.innerHTML = `
                    <button class="chat-message-action-btn" onclick="replyToMessage(${msg.id})" title="${chatTranslations['Répondre']}">↩</button>
                  `;
                }
                headerRight.appendChild(actionsDiv);
              }
              
              const dateSpan = document.createElement('span');
              dateSpan.className = 'chat-message-date';
              dateSpan.innerHTML = `${msg.date} ${msg.time}${msg.edited ? ' <span class="chat-message-edited">(modifié)</span>' : ''}`;
              headerRight.appendChild(dateSpan);
              
              header.appendChild(userSpan);
              header.appendChild(headerRight);
              
              const content = document.createElement('div');
              content.className = 'chat-message-content';
              content.textContent = msg.content;
              
              messageDiv.appendChild(header);
              messageDiv.appendChild(content);
              
              if (msg.link_url) {
                const link = document.createElement('a');
                link.href = msg.link_url;
                link.className = 'chat-message-link';
                link.textContent = 'Voir la tâche →';
                link.target = '_blank';
                messageDiv.appendChild(link);
              }
              
              chatMessages.appendChild(messageDiv);
              
              if (msg.id > lastMessageId && typeof msg.id === 'number') {
                lastMessageId = msg.id;
              }
            }
            
            function renderReportMessage(report) {
              const messageDiv = document.createElement('div');
              messageDiv.className = `chat-message report ${report.is_own ? 'own' : ''}`;
              messageDiv.setAttribute('data-report-id', report.report_id);
              
              const header = document.createElement('div');
              header.className = 'chat-message-header';
              
              const userSpan = document.createElement('span');
              userSpan.className = 'chat-message-user';
              userSpan.textContent = report.user_name;
              
              const headerRight = document.createElement('div');
              headerRight.className = 'chat-message-header-right';
              
              if (report.is_own) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'chat-message-actions';
                actionsDiv.innerHTML = `
                  <button class="chat-message-action-btn" onclick="editReport(${report.report_id})" title="${chatTranslations['Modifier']}"><img src="/static/icons/edit.svg" alt="${chatTranslations['Modifier']}" style="width: 14px; height: 14px;"></button>
                  <button class="chat-message-action-btn" onclick="deleteReport(${report.report_id})" title="${chatTranslations['Supprimer']}"><img src="/static/icons/delete.svg" alt="${chatTranslations['Supprimer']}" style="width: 14px; height: 14px;"></button>
                `;
                headerRight.appendChild(actionsDiv);
              }
              
              const dateSpan = document.createElement('span');
              dateSpan.className = 'chat-message-date';
              dateSpan.innerHTML = `${report.date} ${report.time}${report.edited ? ' <span class="chat-message-edited">(modifié)</span>' : ''}`;
              headerRight.appendChild(dateSpan);
              
              header.appendChild(userSpan);
              header.appendChild(headerRight);
              
              const content = document.createElement('div');
              content.className = 'chat-message-content';
              content.style.whiteSpace = 'pre-wrap';
              content.textContent = report.content;
              
              messageDiv.appendChild(header);
              messageDiv.appendChild(content);
              
              if (report.photos && report.photos.length > 0) {
                const photosDiv = document.createElement('div');
                photosDiv.style.display = 'grid';
                photosDiv.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
                photosDiv.style.gap = '8px';
                photosDiv.style.marginTop = '12px';
                
                report.photos.forEach(photo => {
                  const img = document.createElement('img');
                  img.src = photo.url;
                  img.style.width = '100%';
                  img.style.height = '120px';
                  img.style.objectFit = 'cover';
                  img.style.borderRadius = '4px';
                  img.style.cursor = 'pointer';
                  img.addEventListener('click', function() {
                    if (photoModalEl) {
                      const photoModalImg = photoModalEl.querySelector('#photo-modal-img');
                      if (photoModalImg) {
                        photoModalImg.src = photo.url;
                        if (photoModal) photoModal.show();
                      }
                    }
                  });
                  photosDiv.appendChild(img);
                });
                
                messageDiv.appendChild(photosDiv);
              }
              
              chatMessages.appendChild(messageDiv);
            }
      
      // Load messages
      function loadMessages() {
        fetch('/chat/messages')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              fetch('/reports')
                .then(response => response.json())
                .then(reportData => {
                  let allItems = [];
                  
                  if (reportData.success) {
                    const reportMessages = reportData.reports.map(report => ({
                      id: 'report_' + report.id,
                      type: 'report',
                      user_name: report.user_name,
                      content: report.content,
                      date: new Date(report.created_at).toLocaleDateString('fr-FR'),
                      time: new Date(report.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                      edited: report.edited_at ? true : false,
                      is_own: report.is_own,
                      photos: report.photos || [],
                      report_id: report.id,
                      created_at: report.created_at
                    }));
                    
                    allItems = [...data.messages, ...reportMessages];
                  } else {
                    allItems = data.messages;
                  }
                  
                  allItems.sort((a, b) => {
                    const dateA = a.created_at ? new Date(a.created_at) : new Date(a.date + ' ' + a.time);
                    const dateB = b.created_at ? new Date(b.created_at) : new Date(b.date + ' ' + b.time);
                    return dateA - dateB;
                  });
                  
                  let filteredItems = allItems;
                  if (currentFilter === 'manual') {
                    filteredItems = allItems.filter(item => item.type === 'manual');
                  } else if (currentFilter === 'auto') {
                    filteredItems = allItems.filter(item => item.type === 'auto');
                  } else if (currentFilter === 'report') {
                    filteredItems = allItems.filter(item => item.type === 'report');
                  }
                  
                  renderAllItems(filteredItems);
                })
                .catch(error => {
                  console.error('Error loading reports:', error);
                  let filteredMessages = data.messages;
                  if (currentFilter === 'manual') {
                    filteredMessages = data.messages.filter(msg => msg.type === 'manual');
                  } else if (currentFilter === 'auto') {
                    filteredMessages = data.messages.filter(msg => msg.type === 'auto');
                  } else if (currentFilter === 'report') {
                    filteredMessages = [];
                  }
                  renderAllItems(filteredMessages);
                });
            }
          })
          .catch(error => {
            console.error('Error loading messages:', error);
          });
      }
      
      // Reply to message
      window.replyToMessage = function(messageId) {
        const messageDiv = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
        if (messageDiv) {
          const content = messageDiv.querySelector('.chat-message-content').textContent;
          const userName = messageDiv.querySelector('.chat-message-user').textContent;
          replyingTo = { id: messageId, content: content, user_name: userName };
          
          chatReplyPreview.innerHTML = `
            <div class="chat-reply-preview-content">
              <div class="chat-reply-preview-user">${userName}</div>
              <div class="chat-reply-preview-text">${content.length > 50 ? content.substring(0, 50) + '...' : content}</div>
            </div>
            <button class="chat-reply-preview-close" onclick="cancelReply()">×</button>
          `;
          chatReplyPreview.style.display = 'block';
          chatInput.placeholder = chatTranslations['Répondre à'] + ' ' + userName + '...';
          chatInput.focus();
          cancelEdit();
        }
      };
      
      // Edit message
      window.editMessage = function(messageId, currentContent) {
        editingMessageId = messageId;
        chatInput.value = currentContent;
        chatInput.placeholder = chatTranslations['Modifier le message...'];
        chatSendBtn.textContent = chatTranslations['Modifier'];
        cancelReply();
        chatInput.focus();
      };
      
      // Delete message
      window.deleteMessage = function(messageId) {
        if (!confirm(chatTranslations['Êtes-vous sûr de vouloir supprimer ce message ?'])) return;
        
        fetch(`/chat/${messageId}/delete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            lastMessagesHash = '';
            loadMessages();
          } else {
            alert(chatTranslations['Erreur'] + ': ' + (data.error || chatTranslations['Impossible de supprimer le message']));
          }
        })
        .catch(error => {
          console.error('Error deleting message:', error);
          alert('Erreur lors de la suppression du message');
        });
      };
      
      window.cancelReply = cancelReply;
      
      // Send message
      chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const content = chatInput.value.trim();
      if (!content) return;
      
      chatSendBtn.disabled = true;
      
      if (editingMessageId) {
        fetch(`/chat/${editingMessageId}/edit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            cancelEdit();
            loadMessages();
          } else {
            alert(chatTranslations['Erreur'] + ': ' + (data.error || chatTranslations['Impossible de modifier le message']));
          }
        })
        .catch(error => {
          console.error('Error editing message:', error);
          alert('Erreur lors de la modification du message');
        })
        .finally(() => {
          chatSendBtn.disabled = false;
        });
      } else {
        fetch('/chat/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            content: content,
            reply_to_id: replyingTo ? replyingTo.id : null
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            chatInput.value = '';
            cancelReply();
            lastMessagesHash = '';
            loadMessages();
          } else {
            alert(chatTranslations['Erreur'] + ': ' + (data.error || chatTranslations['Impossible d\'envoyer le message']));
          }
        })
        .catch(error => {
          console.error('Error sending message:', error);
          alert('Erreur lors de l\'envoi du message');
        })
        .finally(() => {
          chatSendBtn.disabled = false;
        });
      }
    });
    
      // Start refresh interval
      function startRefresh() {
        if (refreshInterval) return;
        refreshInterval = setInterval(function() {
          if (!document.hidden) {
            loadMessages();
          }
        }, 10000);
      }
      
      // Initial load - attendre que le DOM soit complètement rendu
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          loadMessages();
          startRefresh();
        });
      });
      
      // Handle visibility change
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          loadMessages();
        }
      });
    }
  })();
</script>
{% endblock %}
