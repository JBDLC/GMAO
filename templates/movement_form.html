{% extends "base.html" %}
{% block title %}{% if is_edit %}Modifier{% else %}Nouveau{% endif %} mouvement{% endblock %}
{% block content %}
<style>
  .page-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .page-title {
    color: #1a3b50;
    font-weight: 700;
    font-size: 2rem;
    letter-spacing: -0.5px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .page-title::before {
    content: '';
    width: 4px;
    height: 32px;
    background: linear-gradient(135deg, #1a3b50 0%, #03192f 100%);
    border-radius: 2px;
  }
  .form-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .form-label {
    color: #1a3b50;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .form-control, .form-select {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    transition: all 0.2s;
  }
  .form-control:focus, .form-select:focus {
    border-color: #1a3b50;
    box-shadow: 0 0 0 0.25rem rgba(26, 59, 80, 0.25);
    outline: none;
  }
  .btn-success {
    background-color: #1a3b50;
    border-color: #1a3b50;
    color: white;
    font-weight: 600;
    padding: 0.5rem 1.5rem;
    border-radius: 4px;
  }
  .btn-success:hover {
    background-color: #03192f;
    border-color: #03192f;
    color: white;
  }
  .btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
    font-weight: 500;
  }
  .btn-secondary:hover {
    background-color: #5a6268;
    border-color: #5a6268;
    color: white;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .form-card {
      padding: 1.25rem;
    }
    
    .row.g-3 > [class*="col"] {
      margin-bottom: 1rem;
    }
    
    .btn-success, .btn-secondary {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }
  
  @media (max-width: 576px) {
    .form-card {
      padding: 1rem;
    }
    
    .row.g-3 > [class*="col"] {
      flex: 0 0 100%;
      max-width: 100%;
    }
    
    .row.g-2 > [class*="col-8"],
    .row.g-2 > [class*="col-4"] {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
</style>

<div class="page-header">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-1">
      <li class="breadcrumb-item"><a href="{{ url_for('movements') }}">Mouvements</a></li>
      {% if is_edit %}
      <li class="breadcrumb-item active" aria-current="page">Modifier</li>
      {% else %}
      <li class="breadcrumb-item active" aria-current="page">Nouveau</li>
      {% endif %}
    </ol>
  </nav>
  <h1 class="page-title">{% if is_edit %}Modifier le mouvement{% else %}Nouveau mouvement{% endif %}</h1>
</div>

<div class="form-card">
<form method="post" id="movementForm">
  <div class="mb-3">
    <label class="form-label">Type</label>
    <select class="form-select" name="type" id="movementType" required>
      <option value="entree" {% if is_edit and movement.type == 'entree' %}selected{% endif %}>Entrée</option>
      <option value="sortie" {% if is_edit and movement.type == 'sortie' %}selected{% endif %}>Sortie</option>
      <option value="transfert" {% if is_edit and movement.type == 'transfert' %}selected{% endif %}>Transfert</option>
    </select>
  </div>
  <div class="row g-3">
    <div class="col">
      <label class="form-label">Stock source</label>
      <select class="form-select" name="source_stock_id" id="sourceStock">
        <option value="">--</option>
        {% for stock in stocks %}
        <option value="{{ stock.id }}" {% if is_edit and movement.source_stock_id == stock.id %}selected{% endif %}>
          {{ stock.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col">
      <label class="form-label">Stock destination</label>
      <select class="form-select" name="dest_stock_id" id="destStock">
        <option value="">--</option>
        {% for stock in stocks %}
        <option value="{{ stock.id }}" {% if is_edit and movement.dest_stock_id == stock.id %}selected{% endif %}>
          {{ stock.name }}
        </option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="mb-3 mt-3">
    <label class="form-label">Date / heure</label>
    <input class="form-control" type="datetime-local" name="created_at" id="movementDate" 
           {% if is_edit and movement.created_at %}
           value="{{ movement.created_at.strftime('%Y-%m-%dT%H:%M') }}"
           {% endif %} />
  </div>
  <hr />
  <h4>Produits</h4>
  <input
    class="form-control mb-2"
    type="text"
    placeholder="Recherche par nom ou code"
    id="productSearch"
  />
  <div id="productRows">
    {% if is_edit and existing_items %}
      {% for product_id, quantity in existing_items %}
      <div class="row g-2 mb-2 product-row">
        <div class="col-8">
          <select class="form-select" name="product_id">
            <option value="">Produit...</option>
            {% for product in products %}
            <option
              value="{{ product.id }}"
              data-search="{{ (product.name ~ ' ' ~ product.code)|lower }}"
              {% if product.id == product_id %}selected{% endif %}
            >
              {{ product.name }} ({{ product.code }})
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-4">
          <input class="form-control" name="quantity" type="number" step="1" min="1" placeholder="Qté" 
                 value="{{ quantity }}" />
        </div>
      </div>
      {% endfor %}
    {% else %}
    <div class="row g-2 mb-2 product-row">
      <div class="col-8">
        <select class="form-select" name="product_id">
          <option value="">Produit...</option>
          {% for product in products %}
          <option
            value="{{ product.id }}"
            data-search="{{ (product.name ~ ' ' ~ product.code)|lower }}"
          >
            {{ product.name }} ({{ product.code }})
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4">
        <input class="form-control" name="quantity" type="number" step="1" min="1" placeholder="Qté" />
      </div>
    </div>
    {% endif %}
  </div>
  <button class="btn btn-outline-secondary btn-sm" type="button" id="addRow">+ Produit</button>
  <div class="mt-3">
    <button class="btn btn-success">{% if is_edit %}Modifier{% else %}Valider{% endif %}</button>
    <a href="{{ url_for('movements') }}" class="btn btn-secondary">Annuler</a>
  </div>
</form>
</div>
{% endblock %}
{% block scripts %}
<script>
  const typeSelect = document.getElementById("movementType");
  const sourceSelect = document.getElementById("sourceStock");
  const destSelect = document.getElementById("destStock");
  const bloc = document.getElementById("productRows");
  const addRowBtn = document.getElementById("addRow");
  const dateInput = document.getElementById("movementDate");
  const form = document.getElementById("movementForm");
  const searchInput = document.getElementById("productSearch");

  function syncStockSelectors() {
    const type = typeSelect.value;
    sourceSelect.closest(".col").classList.toggle("d-none", type === "entree");
    destSelect.closest(".col").classList.toggle("d-none", type === "sortie");
  }

  typeSelect.addEventListener("change", syncStockSelectors);
  syncStockSelectors();

  addRowBtn.addEventListener("click", () => {
    const row = bloc.querySelector(".product-row").cloneNode(true);
    row.querySelectorAll("select, input").forEach((el) => {
      el.value = "";
    });
    bloc.appendChild(row);
  });

  function filterOptions(query) {
    const selects = bloc.querySelectorAll("select");
    selects.forEach((select) => {
      select.querySelectorAll("option").forEach((option) => {
        if (!option.value) return;
        const textData = option.dataset.search || option.textContent.toLowerCase();
        option.hidden = query && !textData.includes(query);
      });
    });
  }

  searchInput.addEventListener("input", () => {
    const query = searchInput.value.trim().toLowerCase();
    filterOptions(query);
  });

  function setNow() {
    if (!dateInput.value) {
      const now = new Date();
      const tzOffset = now.getTimezoneOffset() * 60000;
      const localISOTime = new Date(now.getTime() - tzOffset).toISOString().slice(0, 16);
      dateInput.value = localISOTime;
    }
  }

  setNow();
  form.addEventListener("submit", () => {
    if (!dateInput.value) {
      setNow();
    }
  });
</script>
{% endblock %}









